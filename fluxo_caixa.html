<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxo de Caixa | Âncora</title>
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* Layout Sidebar */
        #wrapper { display: flex; width: 100%; }
        #sidebar-wrapper {
            min-height: 100vh; width: 250px; margin-left: -250px;
            background-color: #2c3e50; transition: margin 0.25s ease-out;
            position: fixed; z-index: 1000;
        }
        #sidebar-wrapper .sidebar-heading { padding: 1.5rem; font-size: 1.2rem; color: white; font-weight: bold; }
        #sidebar-wrapper .list-group-item { background-color: transparent; color: rgba(255,255,255,0.7); border: none; padding: 1rem 1.5rem; }
        #sidebar-wrapper .list-group-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        #sidebar-wrapper .list-group-item.active { background-color: #1a252f; color: white; font-weight: bold; border-left: 4px solid #0dcaf0; }
        #page-content-wrapper { width: 100%; margin-left: 0; transition: margin 0.25s ease-out; }
        @media (min-width: 768px) { #sidebar-wrapper { margin-left: 0; } #page-content-wrapper { margin-left: 250px; } }

        /* --- PLANILHA DRE (VISUAL LIMPO) --- */
        .table-responsive-dre {
            width: 100%; max-height: 80vh; overflow: auto; background: white;
            border: 1px solid #dee2e6; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative;
        }
        .table-dre { 
            font-size: 0.75rem; 
            border-collapse: separate; 
            border-spacing: 0; 
            width: 100%; /* Ocupa largura total */
            min-width: 1200px; /* Garante scroll em telas pequenas */
        }
        .table-dre th, .table-dre td { 
            padding: 6px 8px; vertical-align: middle; white-space: nowrap; 
            border-right: 1px solid #e9ecef; border-bottom: 1px solid #e9ecef; 
        }
        
        /* Coluna Fixa */
        .sticky-col { 
            position: sticky; left: 0; z-index: 5; background-color: #f8f9fa; 
            border-right: 2px solid #ced4da !important; width: 280px; min-width: 280px; 
            overflow: hidden; text-overflow: ellipsis;
        }
        .table-dre thead tr th { position: sticky; top: 0; z-index: 4; background-color: #e9ecef; border-bottom: 2px solid #adb5bd; }
        .table-dre thead tr th.sticky-col { z-index: 6; } /* Cruzamento */

        /* Colunas de Dados */
        .col-valor { 
            text-align: right; font-family: 'Consolas', monospace; font-weight: 600; 
            cursor: help; /* Indica que tem tooltip */
        }
        
        /* Linhas Hierárquicas */
        .row-grupo { background-color: #212529 !important; color: white !important; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .row-cat { background-color: #e9ecef; font-weight: 800; color: #212529; text-transform: uppercase; }
        .row-sub { background-color: #fff; color: #495057; }
        .row-cat-total { background-color: #f8f9fa; font-weight: 700; color: #495057; border-top: 1px solid #dee2e6; font-style: italic; }
        .row-total-saidas { background-color: #ced4da !important; font-weight: 800; border-top: 2px solid #6c757d; }
        .row-saldo { background-color: #2c3e50 !important; color: white !important; font-weight: 900; font-size: 0.9rem; border-top: 3px double white; }

        .val-pos { color: #198754; } 
        .val-neg { color: #dc3545; }
        .indent-cat { padding-left: 10px !important; }
        .indent-sub { padding-left: 30px !important; }
        .indent-total { padding-left: 10px !important; text-align: right; }

        /* Outros */
        .nav-tabs .nav-link.active { font-weight: bold; border-top: 3px solid #2c3e50; }
        .badge-natureza { font-size: 0.65em; opacity: 0.8; margin-left: 5px; }
        .badge-receita { background-color: #198754; color: white; }

        /* --- NOVO ESTILO: SUBCATEGORIAS TRANSPARENTES --- */
        .tr-sub-opacity .col-valor {
            opacity: 0.6; /* Deixa os valores mais claros/transparentes */
            font-weight: 500; /* Reduz levemente o peso da fonte */
        }
        
        /* Opcional: Efeito hover para focar quando passar o mouse */
        .tr-sub-opacity:hover .col-valor {
            opacity: 1;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body>

    <div class="d-flex" id="wrapper">
        <div id="sidebar-wrapper">
            <div class="sidebar-heading"><i class="bi bi-building"></i> Âncora PRO</div>
            <div class="list-group list-group-flush mt-3">
                <a href="#" onclick="irPara('dados_empresa.html')" class="list-group-item list-group-item-action">
                    <i class="bi bi-clipboard-data me-2"></i> Diagnóstico
                </a>
                <a href="#" class="list-group-item list-group-item-action active">
                    <i class="bi bi-cash-stack me-2"></i> Fluxo de Caixa
                </a>
                <a href="#" onclick="irPara('dre.html')" class="list-group-item list-group-item-action">
                    <i class="bi bi-file-earmark-spreadsheet me-2"></i> DRE Gerencial
                </a>
                <a href="#" class="list-group-item list-group-item-action text-muted" style="cursor: not-allowed;">
                    <i class="bi bi-graph-up-arrow me-2"></i> Indicadores
                </a>
                <div class="mt-5 border-top border-secondary pt-3 px-3">
                    <a href="clientes.html" class="btn btn-outline-light w-100 btn-sm">
                        <i class="bi bi-arrow-left"></i> Voltar para Carteira
                    </a>
                </div>
            </div>
        </div>

        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-3 sticky-top shadow-sm">
                <button class="btn btn-primary d-md-none" id="sidebarToggle"><i class="bi bi-list"></i></button>
                <h5 class="ms-3 mb-0 fw-bold text-secondary" id="headerEmpresa">Carregando...</h5>
                <div class="ms-auto d-flex align-items-center gap-2">
                    
                    <div class="d-flex align-items-center bg-danger bg-opacity-10 border border-danger rounded px-2 py-1 me-2">
                        <button class="btn btn-link text-danger btn-sm p-0 fw-bold text-decoration-none" onclick="resetarFluxoTotal()" title="Apagar todos os lançamentos">
                            <i class="bi bi-trash3-fill"></i> Resetar
                        </button>
                    </div>

                    <div class="d-flex align-items-center bg-light border rounded px-2 py-1">
                        <button class="btn btn-link text-secondary btn-sm p-0 me-2" onclick="abrirModalInfoJson()" title="Ver Modelo JSON">
                            <i class="bi bi-info-circle-fill fs-5"></i>
                        </button>
                        <div class="vr me-2"></div>
                        <button class="btn btn-outline-dark btn-sm fw-bold border-0" onclick="triggerImport()" title="Carregar Arquivo">
                            <i class="bi bi-upload"></i> Importar JSON
                        </button>
                        <input type="file" id="inputFileJson" class="d-none" accept=".json" onchange="processarImportacao(this)">
                    </div>

                    <div class="vr mx-2"></div>

                    <button class="btn btn-outline-secondary btn-sm" onclick="abrirModalConfig()"><i class="bi bi-gear-fill"></i> Categorias</button>
                    <button class="btn btn-success fw-bold" onclick="abrirModalLancamento()"><i class="bi bi-plus-lg"></i> Novo</button>
                </div>
            </nav>

            <div class="container-fluid py-4 px-4">
                
                <ul class="nav nav-tabs mb-3" id="viewTabs">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-extrato" data-bs-toggle="tab" data-bs-target="#view-extrato">Extrato Mensal</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-anual" data-bs-toggle="tab" data-bs-target="#view-anual" onclick="carregarVisaoAnual()">Visão Anual (Planilha)
                        </button>                    
                    </li>
                </ul>

                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="view-extrato">
                        <div class="d-flex justify-content-end mb-3 align-items-center gap-2">
                            <label class="fw-bold text-muted small">Mês:</label>
                            <input type="month" id="filtroMes" class="form-control form-control-sm" style="width: 350px;" onchange="carregarLancamentos()">
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4"><div class="card shadow-sm border-start border-1 border-success p-3"><h6 class="text-success small">RECEITAS</h6><h3 class="mb-0 text-success" id="totalReceitas">R$ 0,00</h3></div></div>
                            <div class="col-md-4"><div class="card shadow-sm border-start border-1 border-danger p-3"><h6 class="text-danger small">DESPESAS</h6><h3 class="mb-0 text-danger" id="totalSaidas">R$ 0,00</h3></div></div>
                            <div class="col-md-4"><div class="card shadow-sm border-start border-1 border-primary p-3"><h6 class="text-primary small">SALDO</h6><h3 class="mb-0" id="saldoMes">R$ 0,00</h3></div></div>
                        </div>

                        <div class="card shadow-sm border-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr><th class="ps-4">Data</th><th>Descrição</th><th>Categoria > Sub</th><th>Status</th><th class="text-end pe-4">Valor</th><th></th></tr>
                                    </thead>
                                    <tbody id="tabelaLancamentos"></tbody>
                                </table>
                            </div>
                            <div id="emptyState" class="text-center py-5 d-none"><p class="text-muted">Sem lançamentos.</p></div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="view-anual">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="mudarAno(-1)"><i class="bi bi-chevron-left"></i> Anterior</button>
                                    <span class="mx-3 fw-bold fs-5" id="anoVisaoAnual">2026</span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="mudarAno(1)">Próximo <i class="bi bi-chevron-right"></i></button>
                                </div>
                             <button class="btn btn-success btn-sm fw-bold" onclick="exportarFluxoCSV()"> <i class="bi bi-file-earmark-spreadsheet"></i> Baixar Planilha CSV</button>
                            </div>
                            
                            <div class="table-responsive-dre">
                                <table class="table-dre">
                                    <thead>
                                        <tr>
                                            <th class="sticky-col text-start ps-3">FLUXO DE CAIXA</th>
                                            <th class="text-center">JAN</th>
                                            <th class="text-center">FEV</th>
                                            <th class="text-center">MAR</th>
                                            <th class="text-center">ABR</th>
                                            <th class="text-center">MAI</th>
                                            <th class="text-center">JUN</th>
                                            <th class="text-center">JUL</th>
                                            <th class="text-center">AGO</th>
                                            <th class="text-center">SET</th>
                                            <th class="text-center">OUT</th>
                                            <th class="text-center">NOV</th>
                                            <th class="text-center">DEZ</th>
                                            <th class="text-center bg-dark text-white">TOTAL</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaAnualBody">
                                        </tbody>
                                </table>
                            </div>
                            <div class="card-footer bg-light small text-muted">
                                <i class="bi bi-info-circle-fill text-primary"></i> Passe o mouse sobre os valores para ver a Análise Vertical (% Receita e % Despesa).
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalLancamento" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">Novo Lançamento</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formLancamento" onsubmit="salvarLancamento(event)"><div class="btn-group w-100 mb-3"><input type="radio" class="btn-check" name="tipoMov" id="tipoReceita" value="Receita" onchange="toggleFormTipo()" checked><label class="btn btn-outline-success" for="tipoReceita">Entrada</label><input type="radio" class="btn-check" name="tipoMov" id="tipoSaida" value="Saida" onchange="toggleFormTipo()"><label class="btn btn-outline-danger" for="tipoSaida">Saída</label></div><div class="row g-2 mb-3"><div class="col-6"><input type="date" id="lancData" class="form-control" required></div><div class="col-6"><input type="number" step="0.01" id="lancValor" class="form-control" required placeholder="R$"></div></div><div class="mb-3"><label>Categoria</label><select id="lancCategoria" class="form-select" onchange="carregarSubcategoriasSelect()" required></select></div><div class="mb-3"><label>Subcategoria</label><select id="lancSubcategoria" class="form-select" disabled required></select></div><div class="mb-3"><input type="text" id="lancDescricao" class="form-control" placeholder="Descrição"></div><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="lancStatusRealizado" checked><label class="form-check-label">Realizado</label></div><button type="submit" class="btn btn-success w-100">SALVAR</button></form></div></div></div>
    </div>
    
    <div class="modal fade" id="modalConfig" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-secondary text-white"><h5 class="modal-title">Categorias</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="nav nav-tabs mb-3" id="configTabs"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cfg-panel" onclick="setTipoConfig('Receita')">Receitas</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#cfg-panel" onclick="setTipoConfig('Saida')">Despesas</button></li></ul><div class="row"><div class="col-md-5 border-end"><div class="input-group mb-2"><input type="text" id="novaCatNome" class="form-control form-control-sm"><button class="btn btn-primary btn-sm" onclick="addCategoria()">+</button></div><div class="list-group overflow-auto" style="max-height:300px" id="listaCategoriasConfig"></div></div><div class="col-md-7"><div id="painelSubcat" class="d-none"><h6 id="catSelecionadaNome" class="fw-bold text-primary"></h6><div class="card bg-light p-2 mb-3"><input type="text" id="novaSubNome" class="form-control form-control-sm mb-2" placeholder="Nome Sub"><div class="row g-2" id="divClassificacaoSub"><div class="col-6"><select id="novaSubNatureza" class="form-select form-select-sm"><option value="Custo">Custo</option><option value="Despesa">Despesa</option></select></div><div class="col-6"><select id="novaSubComportamento" class="form-select form-select-sm"><option value="Variavel">Variável</option><option value="Fixa">Fixa</option></select></div></div><button class="btn btn-success btn-sm w-100 mt-2" onclick="addSubcategoria()">Adicionar Sub</button></div><ul class="list-group list-group-flush" id="listaSubcategoriasConfig"></ul></div><div id="painelSubcatVazio" class="text-center text-muted mt-5">Selecione uma categoria.</div></div></div></div></div></div>
    </div>

    <div class="modal fade" id="modalInfoJson" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white"><h5 class="modal-title">Modelo JSON</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body bg-dark text-light p-3 font-monospace small">
<pre class="text-light m-0">[
  { "data": "2026-02-10", "tipo": "Receita", "valor": 12500.00, "descricao": "Venda", "categoria": "Receita Operacional", "subcategoria": "Serviços", "status": "Realizado" },
  { "data": "2026-02-15", "tipo": "Saida", "valor": 300.00, "descricao": "Luz", "categoria": "Estrutura básica", "subcategoria": "Energia", "natureza": "Despesa", "comportamento": "Fixa", "status": "Provisionado" }
]</pre>
                </div>
                <div class="modal-footer bg-dark border-top border-secondary"><button class="btn btn-primary btn-sm" onclick="triggerImport()">Selecionar Arquivo</button></div>
            </div>
        </div>
    </div>

    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        const DB_KEY = 'ancora_empresas';
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('id');
        let anoAtualVisao = new Date().getFullYear();
        let categoriaEmEdicao = null;
        let tipoConfigAtual = 'Receita';

        // --- CONSTANTES DE INICIALIZAÇÃO ---
        
        // Agora Receitas é um OBJETO para incluir subcategorias
        const DEFAULT_REC_DATA = {
            "Receita Operacional": [
                "Venda de produtos", "Prestação de serviços", "Projetos fechados", 
                "Serviços avulsos", "Venda no balcão", "Venda B2B", 
                "Venda B2C", "Personalizações", "Taxas operacionais", "Serviços adicionais (upsell)"
            ],
            "Receita Recorrente": [
                "Mensalidades", "Assinaturas", "Contratos fixos", "Planos de serviço", 
                "Licenças de uso", "Manutenção recorrente", "Suporte técnico mensal", "Retainers / fee mensal"
            ],
            "Receita Financeira": [
                "Juros recebidos", "Rendimentos de aplicações", "Descontos financeiros obtidos", 
                "Cashback", "Variação cambial positiva", "Multas recebidas", "Correção monetária"
            ],
            "Receita Patrimonial": [
                "Aluguel de imóveis", "Locação de equipamentos", "Arrendamento mercantil", 
                "Royalties recebidos", "Licenciamento de marca", "Cessão de uso", "Franquias"
            ],
            "Receita Não Operacional": [
                "Venda de ativo imobilizado", "Venda de veículos", "Venda de equipamentos usados", 
                "Indenizações", "Recuperação de prejuízos", "Ajustes contábeis positivos", "Ganho na baixa de ativos"
            ],
            "Outras Receitas": [
                "Bonificações", "Prêmios", "Incentivos governamentais", "Subvenções", 
                "Doações recebidas", "Patrocínios", "Outras receitas diversas"
            ]
        };

        const DEFAULT_SAI = [
            "Insumos Administrativos", "Estrutura Básica", "Impostos e Taxas", "Recursos Humanos", 
            "Rendimento Sócios", "Prestadores de Serviço", "Banco(s)", "Matéria-Prima", 
            "Marketing e Vendas", "Treinamento e Desenvolvimento", "Máquinas e equipamentos", "Transporte/Frota", "Amortização/Depreciação"
        ];

        document.addEventListener('DOMContentLoaded', () => {
            if(!clientId) { alert("Erro: ID não fornecido"); return; }
            document.getElementById('sidebarToggle').addEventListener('click', e => { e.preventDefault(); document.body.classList.toggle('sb-sidenav-toggled'); });
            document.getElementById('filtroMes').value = new Date().toISOString().slice(0, 7);
            carregarDadosEmpresa();
        });

        document.addEventListener('DOMContentLoaded', () => {
            if(!clientId) { alert("Erro de ID"); return; }
            document.getElementById('sidebarToggle').addEventListener('click', e => { e.preventDefault(); document.body.classList.toggle('sb-sidenav-toggled'); });
            document.getElementById('filtroMes').value = new Date().toISOString().slice(0, 7);
            carregarDadosEmpresa();
        });

        function getDB() { return JSON.parse(localStorage.getItem(DB_KEY)) || []; }
        function saveDB(db) { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        function irPara(pg) { window.location.href = `${pg}?id=${clientId}`; }

        function carregarDadosEmpresa() {
            const db = getDB();
            const index = db.findIndex(c => c.id === clientId);
            if(index === -1) return;
            let empresa = db[index];
            document.getElementById('headerEmpresa').innerText = empresa.empresa;

            if(!empresa.financeiro) empresa.financeiro = [];
            if(!empresa.configCategorias) empresa.configCategorias = [];
            
            // --- SINCRONIZAÇÃO E PROTEÇÃO DE PADRÕES ---
            
            // 1. Atualizar RECEITAS
            for (const [catNome, subsPadrao] of Object.entries(DEFAULT_REC_DATA)) {
                let cat = empresa.configCategorias.find(c => c.nome === catNome && c.tipo === 'Receita');
                
                if (!cat) {
                    cat = { id: Date.now()+Math.random(), nome: catNome, tipo: 'Receita', isDefault: true, subcategorias: [] };
                    empresa.configCategorias.push(cat);
                } else {
                    // Garante que a categoria pai seja padrão
                    cat.isDefault = true; 
                }

                // Sincroniza Subcategorias
                subsPadrao.forEach(subNome => {
                    let sub = cat.subcategorias.find(s => s.nome === subNome);
                    if (sub) {
                        // Se já existe, MARCA COMO PADRÃO (Protege)
                        sub.isDefault = true;
                    } else {
                        // Se não existe, cria protegida
                        cat.subcategorias.push({ nome: subNome, isDefault: true });
                    }
                });
            }

            // 2. Atualizar SAÍDAS (Cria categorias pai se faltar)
            DEFAULT_SAI.forEach(catNome => {
                let cat = empresa.configCategorias.find(c => c.nome === catNome && c.tipo === 'Saida');
                if (!cat) {
                    empresa.configCategorias.push({ id: Date.now()+Math.random(), nome: catNome, tipo: 'Saida', isDefault: true, subcategorias: [] });
                } else {
                    cat.isDefault = true;
                }
            });
            
            db[index] = empresa;
            saveDB(db);
            carregarLancamentos();
        }

        function calcularDadosFluxo(ano) { // Antes era calcularDadosDRE
            const db = getDB();
            const empresa = db.find(c => c.id === clientId);
            const lancs = empresa.financeiro.filter(l => l.data.startsWith(ano.toString()));
            
            const grupos = {
                'RECEITAS': { cats: {}, cor: 'val-pos' },
                'CUSTOS VARIÁVEIS': { cats: {}, cor: 'val-neg' },
                'CUSTOS FIXOS': { cats: {}, cor: 'val-neg' },
                'DESPESAS VARIÁVEIS': { cats: {}, cor: 'val-neg' },
                'DESPESAS FIXAS': { cats: {}, cor: 'val-neg' }
            };

            let recBrutaMes = Array(12).fill(0);
            let despTotalMes = Array(12).fill(0);

            lancs.forEach(l => {
                // FILTRO IMPORTANTE: Remove itens não-caixa desta visualização
                if (l.categoria === "Amortização/Depreciação") return;

                const mes = parseInt(l.data.split('-')[1]) - 1;
                let gKey = '';
                if(l.tipo === 'Receita') {
                    gKey = 'RECEITAS';
                    recBrutaMes[mes] += l.valor;
                } else {
                    despTotalMes[mes] += l.valor;
                    const nat = l.natureza || 'Despesa';
                    const comp = l.comportamento || 'Fixa';
                    if(nat === 'Custo' && comp === 'Variavel') gKey = 'CUSTOS VARIÁVEIS';
                    else if(nat === 'Custo') gKey = 'CUSTOS FIXOS';
                    else if(nat === 'Despesa' && comp === 'Variavel') gKey = 'DESPESAS VARIÁVEIS';
                    else gKey = 'DESPESAS FIXAS';
                }
                
                if(!grupos[gKey].cats[l.categoria]) grupos[gKey].cats[l.categoria] = {};
                if(!grupos[gKey].cats[l.categoria][l.subcategoria]) grupos[gKey].cats[l.categoria][l.subcategoria] = Array(12).fill(0);
                grupos[gKey].cats[l.categoria][l.subcategoria][mes] += l.valor;
            });

            return { grupos, recBrutaMes, despTotalMes };
        }

        // --- RENDERIZAÇÃO NA TELA ---
        // --- RENDERIZAÇÃO DA PLANILHA (RENOMEADA) ---
        function mudarAno(delta) { anoAtualVisao += delta; carregarVisaoAnual(); }
        
        function carregarVisaoAnual() {
            document.getElementById('anoVisaoAnual').innerText = anoAtualVisao;
            const tbody = document.getElementById('tabelaAnualBody');
            tbody.innerHTML = '';

            // Chama a nova função renomeada
            const dados = calcularDadosFluxo(anoAtualVisao);
            const { grupos, recBrutaMes, despTotalMes } = dados;

            // 1. Receitas
            renderGrupoFluxo('RECEITAS', grupos['RECEITAS'], recBrutaMes, despTotalMes, true);

            // 2. Saídas
            ['CUSTOS VARIÁVEIS', 'CUSTOS FIXOS', 'DESPESAS VARIÁVEIS', 'DESPESAS FIXAS'].forEach(g => {
                renderGrupoFluxo(g, grupos[g], recBrutaMes, despTotalMes, false);
            });

            // 3. Resultado
            renderLinhaFluxo('TOTAL DE SAÍDAS', despTotalMes, 'row-total-saidas val-neg', true, recBrutaMes, despTotalMes, false);
            const saldoMes = recBrutaMes.map((v, i) => v - despTotalMes[i]);
            renderLinhaFluxo('SALDO LÍQUIDO DE CAIXA', saldoMes, 'row-saldo', true, recBrutaMes, despTotalMes, true);
        }

        function renderGrupoFluxo(gName, grupo, baseRec, baseDesp, isReceita) {
            const temDados = Object.keys(grupo.cats).length > 0;
            if(!temDados && !isReceita) return;

            renderLinhaFluxo(gName, Array(12).fill(null), 'row-grupo ' + grupo.cor, false, baseRec, baseDesp, isReceita);

            for(const [catNome, subs] of Object.entries(grupo.cats)) {
                let totalCat = Array(12).fill(0);
                for(const vals of Object.values(subs)) vals.forEach((v,i) => totalCat[i] += v);
                
                // Categoria (Título)
                renderLinhaFluxo(catNome, Array(12).fill(null), `row-cat indent-cat ${grupo.cor}`, false, baseRec, baseDesp, isReceita);

                // Subcategorias
                for(const [subNome, vals] of Object.entries(subs)) {
                    renderLinhaFluxo(subNome, vals, `row-sub indent-sub ${grupo.cor}`, true, baseRec, baseDesp, isReceita);
                }
                
                // Total Categoria (Rodapé)
                renderLinhaFluxo(`Total ${catNome}`, totalCat, `row-cat-total indent-total ${grupo.cor}`, true, baseRec, baseDesp, isReceita);
            }
        }

        function renderLinhaFluxo(titulo, valores, classeCSS, temValor, baseRec, baseDesp, isReceita) {
            const tbody = document.getElementById('tabelaAnualBody');
            let cols = '';
            let totalAno = 0;
            const bRec = baseRec || Array(12).fill(0);
            const bDesp = baseDesp || Array(12).fill(0);

            valores.forEach((v, i) => {
                if(v === null || !temValor) {
                    cols += '<td></td>';
                } else {
                    totalAno += v;
                    const valFmt = v !== 0 ? v.toLocaleString('pt-BR',{minimumFractionDigits:2}) : '-';
                    let av1 = (bRec[i] > 0) ? ((v/bRec[i])*100).toFixed(1) : '0.0';
                    let av2 = (bDesp[i] > 0 && !isReceita) ? ((v/bDesp[i])*100).toFixed(1) : '0.0';
                    const tooltip = `Valor: R$ ${valFmt}\n% Receita: ${av1}%\n${!isReceita ? '% Saída: '+av2+'%' : ''}`;
                    cols += `<td class="col-valor" title="${tooltip}">${valFmt}</td>`;
                }
            });

            const totalFmt = temValor ? totalAno.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '';
            const tr = document.createElement('tr');
            if (classeCSS.includes('row-sub')) tr.classList.add('tr-sub-opacity');
            tr.innerHTML = `<td class="sticky-col ${classeCSS}">${titulo}</td>${cols}<td class="col-valor bg-secondary text-white fw-bold">${totalFmt}</td>`;
            tbody.appendChild(tr);
        }

        // --- EXPORTAÇÃO CSV (RENOMEADA) ---
        function exportarFluxoCSV() {
            const dados = calcularDadosFluxo(anoAtualVisao); // Chama a nova função
            const { grupos, recBrutaMes, despTotalMes } = dados;
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Conta / Categoria;Jan;Fev;Mar;Abr;Mai;Jun;Jul;Ago;Set;Out;Nov;Dez;TOTAL ANUAL\n";

            function addLinha(nome, valores) {
                let linha = `"${nome}"`;
                let tot = 0;
                valores.forEach(v => { tot+=v; linha += `;${v.toFixed(2).replace('.', ',')}`; });
                linha += `;${tot.toFixed(2).replace('.', ',')}`;
                csvContent += linha + "\n";
            }

            // Geração
            // 1. Receitas
             addLinha("RECEITAS TOTAIS", recBrutaMes);
            const grpRec = grupos['RECEITAS'];
            for(const [cat, subs] of Object.entries(grpRec.cats)) {
                for(const [sub, vals] of Object.entries(subs)) { addLinha(`  ${cat} > ${sub}`, vals); }
            }

            // 2. Despesas
            const ord = ['CUSTOS VARIÁVEIS', 'CUSTOS FIXOS', 'DESPESAS VARIÁVEIS', 'DESPESAS FIXAS'].forEach(g => {
                addLinha(g, Array(12).fill(0));
                const grp = grupos[g];
                for(const [cat, subs] of Object.entries(grp.cats)) {
                    for(const [sub, vals] of Object.entries(subs)) { addLinha(`  ${cat} > ${sub}`, vals); }
                }
            });

            // 3. Resultado
            const saldoMes = recBrutaMes.map((v, i) => v - despTotalMes[i]);
            addLinha("SALDO FINAL", saldoMes);

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Fluxo_Caixa_Ancora_${anoAtualVisao}.csv`); // Nome do arquivo alterado
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- MANIPULAÇÃO UI (CRUD) ---
        function toggleFormTipo() { setTipoConfig(document.querySelector('input[name="tipoMov"]:checked').value); carregarCategoriasSelect(); }
        function abrirModalLancamento() { document.getElementById('formLancamento').reset(); document.getElementById('lancData').valueAsDate=new Date(); document.getElementById('tipoReceita').checked=true; toggleFormTipo(); new bootstrap.Modal(document.getElementById('modalLancamento')).show(); }
        
        function salvarLancamento(e) {
            e.preventDefault(); const db=getDB(), idx=db.findIndex(c=>c.id===clientId);
            const tipo = document.querySelector('input[name="tipoMov"]:checked').value;
            const cs=document.getElementById('lancCategoria'), ss=document.getElementById('lancSubcategoria');
            
            if(!cs.value || !ss.value) { alert("Categorize!"); return; }
            const cat = cs.options[cs.selectedIndex].text;
            const sub = ss.options[ss.selectedIndex].text;
            let nat='-', comp='-';
            if(tipo==='Saida') {
                nat = ss.options[ss.selectedIndex].getAttribute('data-nat');
                comp = ss.options[ss.selectedIndex].getAttribute('data-comp');
            }

            db[idx].financeiro.push({
                id:Date.now(), data:document.getElementById('lancData').value, tipo:tipo,
                valor:parseFloat(document.getElementById('lancValor').value),
                categoria:cat, subcategoria:sub, natureza:nat, comportamento:comp,
                descricao:document.getElementById('lancDescricao').value,
                status:document.getElementById('lancStatusRealizado').checked?'Realizado':'Provisionado'
            });
            saveDB(db); bootstrap.Modal.getInstance(document.getElementById('modalLancamento')).hide();
            carregarLancamentos(); if(document.getElementById('view-anual').classList.contains('active')) carregarVisaoAnual();
        }

        function excluirLancamento(id) { if(confirm("Excluir?")){const db=getDB(),i=db.findIndex(c=>c.id===clientId);db[i].financeiro=db[i].financeiro.filter(l=>l.id!==id);saveDB(db);carregarLancamentos();carregarVisaoAnual();}}

        function setTipoConfig(t) {
            tipoConfigAtual = t;
            document.getElementById('divClassificacaoSub').style.display = t==='Receita'?'none':'flex';
            document.getElementById('painelSubcat').classList.add('d-none');
            document.getElementById('painelSubcatVazio').classList.remove('d-none');
            renderConfigCats();
        }
        function abrirModalConfig() {
            const tabBtn = document.querySelector('#configTabs button[data-bs-target="#cfg-panel"]');
            if(tabBtn) bootstrap.Tab.getOrCreateInstance(tabBtn).show();
            setTipoConfig('Receita');
            new bootstrap.Modal(document.getElementById('modalConfig')).show();
        }
        function renderConfigCats() {
            const lst=document.getElementById('listaCategoriasConfig'); lst.innerHTML='';
            getDB().find(c=>c.id===clientId).configCategorias.filter(c=>c.tipo===tipoConfigAtual).forEach(c=>{
                const icone = c.isDefault ? '<i class="bi bi-lock-fill text-muted"></i>' : `<i class="bi bi-trash text-danger" onclick="delConfigCat(event,${c.id})"></i>`;
                lst.innerHTML += `<button class="list-group-item list-group-item-action d-flex justify-content-between" onclick="selConfigCat(${c.id})"><span>${c.nome}</span>${icone}</button>`;
            });
        }
        function selConfigCat(id) {
            categoriaEmEdicao = id;
            const c = getDB().find(x=>x.id===clientId).configCategorias.find(x=>x.id==id);
            document.getElementById('painelSubcat').classList.remove('d-none');
            document.getElementById('painelSubcatVazio').classList.add('d-none');
            document.getElementById('catSelecionadaNome').innerText = c.nome;
            renderConfigSubs(c);
        }
   function renderConfigSubs(c) {
            const ul = document.getElementById('listaSubcategoriasConfig');
            ul.innerHTML = '';
            
            c.subcategorias.forEach((s, i) => {
                let extraInfo = '';
                
                // Badges de Saída
                if(c.tipo === 'Saida') {
                    extraInfo = `<small class="badge bg-secondary ms-2">${s.natureza||'-'}</small><small class="badge bg-light text-dark border ms-1">${s.comportamento||'-'}</small>`;
                }

                // Ícone de Ação (Lixeira ou Cadeado)
                const actionIcon = s.isDefault 
                    ? '<i class="bi bi-lock-fill text-muted" title="Item Padrão (Não pode excluir)"></i>' 
                    : `<i class="bi bi-trash text-danger cursor-pointer" onclick="delConfigSub(${i})"></i>`;

                ul.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>${s.nome} ${extraInfo}</div>
                        ${actionIcon}
                    </li>`;
            });
        }
        function addCategoria() {
            const n=document.getElementById('novaCatNome').value; if(!n)return;
            const db=getDB(), i=db.findIndex(c=>c.id===clientId);
            db[i].configCategorias.push({id:Date.now(), nome:n, tipo:tipoConfigAtual, isDefault:false, subcategorias:[]});
            saveDB(db); document.getElementById('novaCatNome').value=''; renderConfigCats();
        }
        function delConfigCat(e,id) { e.stopPropagation(); if(confirm('Excluir?')){const db=getDB(),i=db.findIndex(c=>c.id===clientId);db[i].configCategorias=db[i].configCategorias.filter(c=>c.id!==id);saveDB(db);renderConfigCats();document.getElementById('painelSubcat').classList.add('d-none');}}
        function addSubcategoria() {
            const n=document.getElementById('novaSubNome').value; if(!n)return;
            const db=getDB(), i=db.findIndex(c=>c.id===clientId);
            const cat=db[i].configCategorias.find(c=>c.id==categoriaEmEdicao);
            const nova={nome:n};
            if(tipoConfigAtual==='Saida'){ nova.natureza=document.getElementById('novaSubNatureza').value; nova.comportamento=document.getElementById('novaSubComportamento').value; }
            cat.subcategorias.push(nova); saveDB(db); document.getElementById('novaSubNome').value=''; renderConfigSubs(cat);
        }
        function delConfigSub(subIdx) {
            const db = getDB();
            const idx = db.findIndex(c => c.id === clientId);
            const cat = db[idx].configCategorias.find(c => c.id == categoriaEmEdicao);
            
            // Verificação de Segurança
            if(cat.subcategorias[subIdx].isDefault) {
                alert("Esta é uma subcategoria padrão do sistema e não pode ser excluída.");
                return;
            }

            if(confirm("Excluir subcategoria?")) {
                cat.subcategorias.splice(subIdx, 1);
                saveDB(db);
                renderConfigSubs(cat);
            }
        }
        function carregarCategoriasSelect() {
            const sel=document.getElementById('lancCategoria'), sub=document.getElementById('lancSubcategoria');
            const tipo=document.querySelector('input[name="tipoMov"]:checked').value;
            sel.innerHTML='<option value="">Selecione...</option>'; sub.innerHTML='<option value="">Selecione...</option>'; sub.disabled=true;
            getDB().find(c=>c.id===clientId).configCategorias.filter(c=>c.tipo===tipo).forEach(c=> sel.innerHTML+=`<option value="${c.id}">${c.nome}</option>`);
        }
        function carregarSubcategoriasSelect() {
            const id = document.getElementById('lancCategoria').value;
            const sub = document.getElementById('lancSubcategoria');
            
            if(!id) {
                sub.disabled = true;
                sub.innerHTML = '<option value="">Selecione Categoria...</option>';
                return;
            }
            
            const c = getDB().find(x => x.id === clientId).configCategorias.find(x => x.id == id);
            
            sub.innerHTML = '<option value="">Selecione...</option>';
            sub.disabled = false;
            
            if (c.subcategorias && c.subcategorias.length > 0) {
                c.subcategorias.forEach(s => { 
                    const o = document.createElement('option'); 
                    o.text = s.nome; 
                    
                    // Só adiciona atributos se for Saída (Receita não usa Natureza/Comportamento no cadastro)
                    if(c.tipo === 'Saida'){ 
                        o.setAttribute('data-nat', s.natureza || 'Despesa'); 
                        o.setAttribute('data-comp', s.comportamento || 'Fixa'); 
                    } 
                    sub.add(o); 
                });
            } else {
                sub.innerHTML = '<option value="">Sem subcategorias (Cadastre na engrenagem)</option>';
            }
        }
        
        function abrirModalInfoJson() { new bootstrap.Modal(document.getElementById('modalInfoJson')).show(); }
        function triggerImport(){ document.getElementById('inputFileJson').click(); }
        function processarImportacao(input){
            if(!input.files.length)return;
            const r=new FileReader(); r.onload=e=>{ try{
                const d=JSON.parse(e.target.result), db=getDB(), i=db.findIndex(c=>c.id===clientId);
                d.forEach(x=> db[i].financeiro.push({id:Date.now()+Math.random(), data:x.data, tipo:x.tipo, valor:parseFloat(x.valor), categoria:x.categoria||'-', subcategoria:x.subcategoria||'-', natureza:x.natureza||'-', comportamento:x.comportamento||'-', descricao:x.descricao||'Imp', status:'Realizado'}));
                saveDB(db); alert('Importado com Sucesso!'); carregarLancamentos();
                const m = bootstrap.Modal.getInstance(document.getElementById('modalInfoJson')); if(m) m.hide();
            }catch(err){alert('Erro ao ler JSON: Formato inválido.');}}; r.readAsText(input.files[0]);
        }
        
        function carregarLancamentos() {
            const db = getDB();
            const empresa = db.find(c => c.id === clientId);
            const mes = document.getElementById('filtroMes').value;
            const tb = document.getElementById('tabelaLancamentos');
            tb.innerHTML = '';

            const fs = empresa.financeiro.filter(l => l.data.startsWith(mes));
            let r = 0, s = 0;

            if(fs.length === 0) {
                document.getElementById('emptyState').classList.remove('d-none');
            } else {
                document.getElementById('emptyState').classList.add('d-none');
                fs.sort((a,b) => new Date(b.data) - new Date(a.data));

                fs.forEach(l => {
                    // Verifica se é item não-caixa (Contábil)
                    const isNonCash = l.categoria === "Amortização/Depreciação";

                    // SOMAS (Lógica de Caixa)
                    if(l.tipo === 'Receita') {
                        r += l.valor; 
                    } else {
                        // Só soma nas saídas se NÃO for depreciação
                        if (!isNonCash) {
                            s += l.valor;
                        }
                    }

                    // VISUAL
                    let bTipo = '';
                    let cor = '';
                    let rowStyle = '';
                    let valStyle = '';

                    if (l.tipo === 'Receita') {
                        bTipo = '<span class="badge badge-receita">Receita</span>';
                        cor = 'text-success';
                    } else if (isNonCash) {
                        // Estilo especial para Depreciação
                        bTipo = '<span class="badge bg-secondary">Contábil</span>';
                        cor = 'text-muted'; // Valor cinza
                        rowStyle = 'background-color: #f8f9fa; font-style: italic;'; // Linha inteira diferenciada
                        valStyle = 'text-decoration: line-through; opacity: 0.7;'; // Riscado para indicar que não soma
                    } else {
                        bTipo = `<span class="badge bg-secondary badge-natureza">${l.natureza}</span>`;
                        cor = 'text-danger';
                    }

                    // Renderiza Linha
                    tb.innerHTML += `
                        <tr style="${rowStyle}">
                            <td class="ps-4">${l.data.split('-').reverse().join('/')}</td>
                            <td class="fw-bold text-dark">${l.descricao}</td>
                            <td>
                                <small class="d-block text-muted">${l.categoria}</small>
                                ${l.subcategoria}
                            </td>
                            <td>${bTipo}</td>
                            <td class="text-end pe-4 fw-bold ${cor}" style="${valStyle}">
                                ${l.tipo === 'Saida' ? '-' : ''} ${l.valor.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
                            </td>
                            <td class="text-end">
                                <i class="bi bi-trash text-danger cursor-pointer" onclick="excluirLancamento(${l.id})"></i>
                            </td>
                        </tr>`;
                });
            }

            document.getElementById('totalReceitas').innerText = r.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('totalSaidas').innerText = s.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            
            const sal = r - s;
            document.getElementById('saldoMes').innerText = sal.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('saldoMes').className = `fw-bold mb-0 ${sal >= 0 ? 'text-success' : 'text-danger'}`;
        }

        // --- FUNÇÃO DE RESET TOTAL (SEGURANÇA MÁXIMA) ---
        function resetarFluxoTotal() {
            // 1. Primeira barreira: Confirmação de intenção
            if(!confirm("⚠️ PERIGO EXTREMO ⚠️\n\nVocê está prestes a apagar TODO o histórico financeiro desta empresa (todos os anos).\nEssa ação é irreversível e não pode ser desfeita.\n\nDeseja realmente continuar?")) {
                return;
            }

            // 2. Segunda barreira: Senha Administrativa
            const senha = prompt("Para confirmar a exclusão total da base de dados, digite a senha de segurança:");

            if (senha === "Nimbus27@9") {
                const db = getDB();
                const index = db.findIndex(c => c.id === clientId);
                
                if (index !== -1) {
                    // Mantém as configurações de categorias, apaga apenas os lançamentos
                    db[index].financeiro = []; 
                    
                    saveDB(db);
                    
                    alert("✅ SUCESSO: Todos os lançamentos financeiros foram apagados.");
                    
                    // Atualiza a tela imediatamente
                    carregarLancamentos();
                    if(document.getElementById('view-anual').classList.contains('active')) {
                        carregarVisaoAnual();
                    }
                }
            } else if (senha !== null) { // Só avisa se não for cancelamento
                alert("⛔ ERRO: Senha incorreta. Nenhuma alteração foi feita.");
            }
        }
    </script>
</body>
</html>