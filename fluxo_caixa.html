<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxo de Caixa | Âncora</title>
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* Sidebar */
        #wrapper { display: flex; width: 100%; }
        #sidebar-wrapper {
            min-height: 100vh; width: 250px; margin-left: -250px;
            background-color: #2c3e50; transition: margin 0.25s ease-out;
            position: fixed; z-index: 1000;
        }
        #sidebar-wrapper .sidebar-heading { padding: 1.5rem; font-size: 1.2rem; color: white; font-weight: bold; }
        #sidebar-wrapper .list-group-item { background-color: transparent; color: rgba(255,255,255,0.7); border: none; padding: 1rem 1.5rem; }
        #sidebar-wrapper .list-group-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        #sidebar-wrapper .list-group-item.active { background-color: #1a252f; color: white; font-weight: bold; border-left: 4px solid #0dcaf0; }
        #page-content-wrapper { width: 100%; margin-left: 0; transition: margin 0.25s ease-out; }
        @media (min-width: 768px) { #sidebar-wrapper { margin-left: 0; } #page-content-wrapper { margin-left: 250px; } }

        /* Estilos Específicos */
        .card-valor { transition: transform 0.2s; }
        .card-valor:hover { transform: translateY(-3px); }
        .border-receita { border-left: 5px solid #198754 !important; }
        .border-saida { border-left: 5px solid #dc3545 !important; }
        .border-saldo { border-left: 5px solid #0dcaf0 !important; }
        
        .badge-custo { background-color: #dc3545; color: white; }
        .badge-despesa { background-color: #fd7e14; color: white; }
        .badge-fixa { border: 1px solid #dee2e6; color: #495057; background: #e9ecef; }
        .badge-variavel { border: 1px solid #dee2e6; color: #495057; background: #fff; }
        .provisionado-row { background-color: #fff3cd !important; font-style: italic; color: #664d03; }
        
        /* JSON Code Block */
        pre.json-model { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 5px; font-size: 0.85rem; }
        .key { color: #e06c75; } .string { color: #98c379; } .number { color: #d19a66; }
        
        /* Tabela Anual */
        .table-anual th, .table-anual td { font-size: 0.85rem; padding: 0.4rem; white-space: nowrap; }
        .table-anual th.sticky-col { position: sticky; left: 0; background-color: #f8f9fa; z-index: 10; border-right: 2px solid #dee2e6; min-width: 200px; }
        .col-mes { min-width: 100px; text-align: right; }
    </style>
</head>
<body>

    <div class="d-flex" id="wrapper">
        <div id="sidebar-wrapper">
            <div class="sidebar-heading"><i class="bi bi-building"></i> Âncora PRO</div>
            <div class="list-group list-group-flush mt-3">
                <a href="#" onclick="irPara('dados_empresa.html')" class="list-group-item list-group-item-action">
                    <i class="bi bi-clipboard-data me-2"></i> Diagnóstico
                </a>
                <a href="#" class="list-group-item list-group-item-action active">
                    <i class="bi bi-cash-stack me-2"></i> Fluxo de Caixa
                </a>
                <a href="#" class="list-group-item list-group-item-action text-muted" style="cursor: not-allowed;">
                    <i class="bi bi-graph-up-arrow me-2"></i> Indicadores
                </a>
                <div class="mt-5 border-top border-secondary pt-3 px-3">
                    <a href="clientes.html" class="btn btn-outline-light w-100 btn-sm">
                        <i class="bi bi-arrow-left"></i> Voltar para Carteira
                    </a>
                </div>
            </div>
        </div>

        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-3 sticky-top shadow-sm">
                <button class="btn btn-primary d-md-none" id="sidebarToggle"><i class="bi bi-list"></i></button>
                <h5 class="ms-3 mb-0 fw-bold text-secondary" id="headerEmpresa">Carregando...</h5>
                <div class="ms-auto d-flex align-items-center gap-2">
                    <button class="btn btn-outline-dark btn-sm" onclick="triggerImport()" title="Importar JSON">
                        <i class="bi bi-upload"></i> Importar
                    </button>
                    <button class="btn btn-link text-muted btn-sm p-0 me-2" onclick="abrirModalInfoJson()" title="Ver Modelo JSON">
                        <i class="bi bi-info-circle fs-5"></i>
                    </button>
                    <input type="file" id="inputFileJson" class="d-none" accept=".json" onchange="processarImportacao(this)">

                    <button class="btn btn-outline-secondary btn-sm" onclick="abrirModalConfig()">
                        <i class="bi bi-gear-fill"></i> Categorias
                    </button>
                    <button class="btn btn-success fw-bold" onclick="abrirModalLancamento()">
                        <i class="bi bi-plus-lg"></i> Novo
                    </button>
                </div>
            </nav>

            <div class="container-fluid py-4 px-4">
                
                <ul class="nav nav-tabs mb-4" id="viewTabs">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-extrato" data-bs-toggle="tab" data-bs-target="#view-extrato" type="button">
                            <i class="bi bi-list-ul"></i> Extrato Mensal
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-anual" data-bs-toggle="tab" data-bs-target="#view-anual" type="button" onclick="carregarVisaoAnual()">
                            <i class="bi bi-table"></i> Visão Anual (Planilha)
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="view-extrato">
                        <div class="d-flex justify-content-end mb-3 align-items-center gap-2">
                            <label class="fw-bold text-muted small">Período:</label>
                            <input type="month" id="filtroMes" class="form-control form-control-sm" style="width: 150px;" onchange="carregarLancamentos()">
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm border-receita card-valor">
                                    <div class="card-body">
                                        <h6 class="text-muted text-uppercase small fw-bold">Receitas</h6>
                                        <h3 class="text-success fw-bold mb-0" id="totalReceitas">R$ 0,00</h3>
                                        <small class="text-muted" id="receitasProv">Prov: R$ 0,00</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm border-saida card-valor">
                                    <div class="card-body">
                                        <h6 class="text-muted text-uppercase small fw-bold">Saídas Totais</h6>
                                        <h3 class="text-danger fw-bold mb-0" id="totalSaidas">R$ 0,00</h3>
                                        <small class="text-muted" id="saidasProv">Prov: R$ 0,00</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm border-saldo card-valor">
                                    <div class="card-body">
                                        <h6 class="text-muted text-uppercase small fw-bold">Saldo do Mês</h6>
                                        <h3 class="fw-bold mb-0" id="saldoMes">R$ 0,00</h3>
                                        <small class="text-muted">Projetado</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow-sm border-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-4">Data</th>
                                            <th>Descrição</th>
                                            <th>Classificação</th>
                                            <th>Status</th>
                                            <th class="text-end pe-4">Valor (R$)</th>
                                            <th class="text-end">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaLancamentos"></tbody>
                                </table>
                            </div>
                            <div id="emptyState" class="text-center py-5 d-none">
                                <p class="text-muted">Nenhum lançamento neste mês.</p>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="view-anual">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                                <button class="btn btn-outline-secondary btn-sm" onclick="mudarAno(-1)"><i class="bi bi-chevron-left"></i> Anterior</button>
                                <h5 class="m-0 fw-bold" id="anoVisaoAnual">2026</h5>
                                <button class="btn btn-outline-secondary btn-sm" onclick="mudarAno(1)">Próximo <i class="bi bi-chevron-right"></i></button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped table-anual mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th class="sticky-col">CATEGORIA / SUBCATEGORIA</th>
                                            <th class="col-mes">JAN</th> <th class="col-mes">FEV</th> <th class="col-mes">MAR</th>
                                            <th class="col-mes">ABR</th> <th class="col-mes">MAI</th> <th class="col-mes">JUN</th>
                                            <th class="col-mes">JUL</th> <th class="col-mes">AGO</th> <th class="col-mes">SET</th>
                                            <th class="col-mes">OUT</th> <th class="col-mes">NOV</th> <th class="col-mes">DEZ</th>
                                            <th class="col-mes bg-secondary text-white">TOTAL</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaAnualBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalLancamento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Novo Movimento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formLancamento" onsubmit="salvarLancamento(event)">
                        <div class="btn-group w-100 mb-3">
                            <input type="radio" class="btn-check" name="tipoMov" id="tipoReceita" value="Receita" onchange="toggleFormTipo()" checked>
                            <label class="btn btn-outline-success" for="tipoReceita">Entrada (Receita)</label>
                            <input type="radio" class="btn-check" name="tipoMov" id="tipoSaida" value="Saida" onchange="toggleFormTipo()">
                            <label class="btn btn-outline-danger" for="tipoSaida">Saída (Custo/Desp)</label>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">Data</label>
                                <input type="date" id="lancData" class="form-control" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Valor (R$)</label>
                                <input type="number" step="0.01" id="lancValor" class="form-control" required placeholder="0,00">
                            </div>
                        </div>
                        <div id="areaCategorias" class="d-none">
                            <div class="mb-3">
                                <label class="form-label">Categoria</label>
                                <select id="lancCategoria" class="form-select" onchange="carregarSubcategoriasSelect()"></select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subcategoria</label>
                                <select id="lancSubcategoria" class="form-select" disabled>
                                    <option value="">Selecione Categoria...</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <input type="text" id="lancDescricao" class="form-control" placeholder="Detalhes...">
                        </div>
                        <div class="form-check form-switch mb-4 p-3 border rounded bg-light">
                            <input class="form-check-input ms-0 me-2" type="checkbox" id="lancStatusRealizado" checked>
                            <label class="form-check-label fw-bold" for="lancStatusRealizado">Lançamento Realizado</label>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success fw-bold">SALVAR</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalInfoJson" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-file-earmark-code"></i> Modelo de Importação</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Crie um arquivo <strong>.json</strong> contendo uma lista de objetos conforme o modelo abaixo.</p>
                    <p class="small text-muted"><i class="bi bi-exclamation-triangle"></i> Lançamentos sem "categoria" serão tratados como Receita Simples. Para Saídas, "categoria" e "subcategoria" são ideais.</p>
                    
                    <pre class="json-model">
[
  {
    <span class="key">"data"</span>: <span class="string">"2026-02-10"</span>,
    <span class="key">"tipo"</span>: <span class="string">"Receita"</span>,
    <span class="key">"valor"</span>: <span class="number">15000.00</span>,
    <span class="key">"descricao"</span>: <span class="string">"Consultoria ABC"</span>,
    <span class="key">"status"</span>: <span class="string">"Realizado"</span>
  },
  {
    <span class="key">"data"</span>: <span class="string">"2026-02-15"</span>,
    <span class="key">"tipo"</span>: <span class="string">"Saida"</span>,
    <span class="key">"valor"</span>: <span class="number">450.00</span>,
    <span class="key">"descricao"</span>: <span class="string">"Energia Elétrica"</span>,
    <span class="key">"categoria"</span>: <span class="string">"Estrutura básica"</span>,
    <span class="key">"subcategoria"</span>: <span class="string">"Luz"</span>,
    <span class="key">"natureza"</span>: <span class="string">"Despesa"</span>,
    <span class="key">"comportamento"</span>: <span class="string">"Fixa"</span>,
    <span class="key">"status"</span>: <span class="string">"Provisionado"</span>
  }
]</pre>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button class="btn btn-primary" onclick="triggerImport()">Selecionar Arquivo Agora</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalConfig" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title">Categorias</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5 border-end">
                            <div class="input-group mb-2">
                                <input type="text" id="novaCatNome" class="form-control form-control-sm" placeholder="Nova Categoria...">
                                <button class="btn btn-primary btn-sm" onclick="addCategoria()"><i class="bi bi-plus"></i></button>
                            </div>
                            <div class="list-group overflow-auto" style="max-height: 300px;" id="listaCategoriasConfig"></div>
                        </div>
                        <div class="col-md-7">
                            <div id="painelSubcat" class="d-none">
                                <h6 class="fw-bold"><span id="catSelecionadaNome" class="text-primary"></span></h6>
                                <div class="card bg-light p-2 mb-3">
                                    <input type="text" id="novaSubNome" class="form-control form-control-sm mb-2" placeholder="Nome Subcategoria">
                                    <div class="row g-2">
                                        <div class="col-6"><select id="novaSubNatureza" class="form-select form-select-sm"><option value="Custo">Custo</option><option value="Despesa">Despesa</option></select></div>
                                        <div class="col-4"><select id="novaSubComportamento" class="form-select form-select-sm"><option value="Variavel">Variável</option><option value="Fixa">Fixa</option></select></div>
                                        <div class="col-2"><button class="btn btn-success btn-sm w-100" onclick="addSubcategoria()"><i class="bi bi-plus"></i></button></div>
                                    </div>
                                </div>
                                <ul class="list-group list-group-flush" id="listaSubcategoriasConfig"></ul>
                            </div>
                            <div id="painelSubcatVazio" class="text-center text-muted mt-5">Selecione uma categoria.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        const DB_KEY = 'ancora_empresas';
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('id');
        let anoAtualVisao = new Date().getFullYear();
        let categoriaEmEdicao = null;

        const DEFAULT_CATS = [
            "Insumos administrativos", "Estrutura básica", "Impostos e taxas", 
            "Recursos Humanos", "Rendimento Sócios/Pró-labore", "Prestadores de serviço", 
            "Banco(s)", "Matéria prima", "Marketing e vendas", 
            "Treinamento e desenvolvimento", "Máquinas e equipamentos", "Transporte/frota/Automóveis"
        ];

        document.addEventListener('DOMContentLoaded', () => {
            if(!clientId) { alert("Erro de ID"); return; }
            document.getElementById('sidebarToggle').addEventListener('click', e => { e.preventDefault(); document.body.classList.toggle('sb-sidenav-toggled'); });
            document.getElementById('filtroMes').value = new Date().toISOString().slice(0, 7);
            carregarDadosEmpresa();
        });

        function getDB() { return JSON.parse(localStorage.getItem(DB_KEY)) || []; }
        function saveDB(db) { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        function irPara(pg) { window.location.href = `${pg}?id=${clientId}`; }

        function carregarDadosEmpresa() {
            const db = getDB();
            const index = db.findIndex(c => c.id === clientId);
            if(index === -1) return;
            let empresa = db[index];

            document.getElementById('headerEmpresa').innerText = empresa.empresa;

            if(!empresa.financeiro) { empresa.financeiro = []; db[index] = empresa; saveDB(db); }
            if(!empresa.configCategorias) {
                empresa.configCategorias = DEFAULT_CATS.map(nome => ({ id: Date.now()+Math.random(), nome: nome, isDefault: true, subcategorias: [] }));
                db[index] = empresa;
                saveDB(db);
            }
            carregarLancamentos();
        }

        // --- IMPORTAÇÃO JSON ---
        function abrirModalInfoJson() { new bootstrap.Modal(document.getElementById('modalInfoJson')).show(); }
        function triggerImport() { document.getElementById('inputFileJson').click(); }
        
        function processarImportacao(input) {
            if (input.files.length === 0) return;
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    if (!Array.isArray(dados)) throw new Error("O arquivo deve conter uma lista (array) de objetos.");
                    
                    const db = getDB();
                    const index = db.findIndex(c => c.id === clientId);
                    let importadosCount = 0;

                    dados.forEach(item => {
                        // Validação básica
                        if(item.data && item.valor && item.tipo) {
                            db[index].financeiro.push({
                                id: Date.now() + Math.random(), // Novo ID único
                                data: item.data, // Formato YYYY-MM-DD
                                tipo: item.tipo, // Receita ou Saida
                                valor: parseFloat(item.valor),
                                descricao: item.descricao || 'Importado',
                                categoria: item.categoria || '-',
                                subcategoria: item.subcategoria || '-',
                                natureza: item.natureza || (item.tipo === 'Saida' ? 'Custo' : '-'),
                                comportamento: item.comportamento || (item.tipo === 'Saida' ? 'Variavel' : '-'),
                                status: item.status || 'Realizado'
                            });
                            importadosCount++;
                        }
                    });

                    saveDB(db);
                    alert(`Sucesso! ${importadosCount} lançamentos importados.`);
                    carregarLancamentos();
                    
                    // Fecha modal se estiver aberto
                    const modalEl = document.getElementById('modalInfoJson');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if(modal) modal.hide();

                } catch (erro) {
                    alert("Erro ao ler JSON: " + erro.message);
                }
                input.value = ''; // Reset input
            };
            reader.readAsText(file);
        }

        // --- LÓGICA DE EXTRATO (Igual anterior) ---
        function carregarLancamentos() {
            const db = getDB();
            const empresa = db.find(c => c.id === clientId);
            const mesAno = document.getElementById('filtroMes').value; 
            const tbody = document.getElementById('tabelaLancamentos');
            tbody.innerHTML = '';
            let totais = { receita: 0, saida: 0, recProv: 0, saiProv: 0 };
            const filtrados = empresa.financeiro.filter(l => l.data.startsWith(mesAno));

            if(filtrados.length === 0) { document.getElementById('emptyState').classList.remove('d-none'); } 
            else {
                document.getElementById('emptyState').classList.add('d-none');
                filtrados.sort((a,b) => new Date(b.data) - new Date(a.data));
                filtrados.forEach(l => {
                    const isProv = l.status === 'Provisionado';
                    if(l.tipo === 'Receita') { totais.receita += l.valor; if(isProv) totais.recProv += l.valor; } 
                    else { totais.saida += l.valor; if(isProv) totais.saiProv += l.valor; }

                    const classRow = isProv ? 'provisionado-row' : '';
                    const statusBadge = isProv ? '<span class="badge bg-warning text-dark">Agendado</span>' : '<span class="badge bg-success">Realizado</span>';
                    
                    let classificacaoHtml = '-';
                    if(l.tipo === 'Saida') {
                        classificacaoHtml = `<small class="d-block text-muted">${l.categoria} > ${l.subcategoria}</small><span class="badge badge-${l.natureza?.toLowerCase()} me-1">${l.natureza}</span><span class="badge badge-${l.comportamento?.toLowerCase()}">${l.comportamento}</span>`;
                    } else { classificacaoHtml = '<span class="text-success fw-bold">Entrada</span>'; }

                    tbody.innerHTML += `<tr class="${classRow}"><td class="ps-4 text-nowrap">${l.data.split('-').reverse().join('/')}</td><td class="fw-bold">${l.descricao}</td><td>${classificacaoHtml}</td><td>${statusBadge}</td><td class="text-end pe-4 fw-bold ${l.tipo === 'Receita'?'text-success':'text-danger'}">${l.tipo==='Saida'?'-':''} ${l.valor.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="excluirLancamento(${l.id})"><i class="bi bi-trash"></i></button></td></tr>`;
                });
            }
            document.getElementById('totalReceitas').innerText = totais.receita.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('totalSaidas').innerText = totais.saida.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('receitasProv').innerText = `Prov: ${totais.recProv.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`;
            document.getElementById('saidasProv').innerText = `Prov: ${totais.saiProv.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`;
            const saldo = totais.receita - totais.saida;
            const elSaldo = document.getElementById('saldoMes');
            elSaldo.innerText = saldo.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            elSaldo.className = `fw-bold mb-0 ${saldo >= 0 ? 'text-success' : 'text-danger'}`;
        }

        // --- LÓGICA ANUAL ---
        function mudarAno(delta) { anoAtualVisao += delta; carregarVisaoAnual(); }
        function carregarVisaoAnual() {
            document.getElementById('anoVisaoAnual').innerText = anoAtualVisao;
            const db = getDB();
            const empresa = db.find(c => c.id === clientId);
            const tbody = document.getElementById('tabelaAnualBody');
            tbody.innerHTML = '';

            const lancamentosAno = empresa.financeiro.filter(l => l.data.startsWith(anoAtualVisao.toString()));
            const mapaDados = new Map();
            let totalRec = Array(12).fill(0), totalSai = Array(12).fill(0);

            lancamentosAno.forEach(l => {
                const mes = parseInt(l.data.split('-')[1]) - 1;
                if(l.tipo === 'Receita') totalRec[mes] += l.valor;
                else {
                    totalSai[mes] += l.valor;
                    const chave = `${l.categoria} > ${l.subcategoria}`;
                    if(!mapaDados.has(chave)) mapaDados.set(chave, Array(12).fill(0));
                    mapaDados.get(chave)[mes] += l.valor;
                }
            });

            renderLinha('RECEITA BRUTA', totalRec, 'bg-success text-white fw-bold');
            mapaDados.forEach((vals, nome) => { if(vals.reduce((a,b)=>a+b,0)>0) renderLinha(nome, vals, ''); });
            const saldo = totalRec.map((r,i) => r - totalSai[i]);
            renderLinha('SALDO / LUCRO', saldo, 'bg-dark text-white fw-bold border-top border-3');
        }

        function renderLinha(tit, vals, css) {
            const tot = vals.reduce((a,b)=>a+b,0);
            let cols = ''; vals.forEach(v => cols += `<td class="col-mes">${v!==0?v.toLocaleString('pt-BR',{minimumFractionDigits:2}):'-'}</td>`);
            document.getElementById('tabelaAnualBody').innerHTML += `<tr><td class="sticky-col ${css}">${tit}</td>${cols}<td class="col-mes fw-bold bg-light">${tot.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td></tr>`;
        }

        // --- CRUD BÁSICO ---
        function toggleFormTipo() {
            const tipo = document.querySelector('input[name="tipoMov"]:checked').value;
            const area = document.getElementById('areaCategorias');
            if(tipo === 'Receita') area.classList.add('d-none'); else { area.classList.remove('d-none'); carregarCategoriasSelect(); }
        }
        function abrirModalLancamento() { document.getElementById('formLancamento').reset(); document.getElementById('lancData').valueAsDate = new Date(); toggleFormTipo(); new bootstrap.Modal(document.getElementById('modalLancamento')).show(); }
        function salvarLancamento(e) {
            e.preventDefault();
            const db = getDB();
            const index = db.findIndex(c => c.id === clientId);
            const tipo = document.querySelector('input[name="tipoMov"]:checked').value;
            let cat='-', sub='-', nat='-', comp='-';
            if(tipo==='Saida') {
                const cs=document.getElementById('lancCategoria'), ss=document.getElementById('lancSubcategoria');
                if(!cs.value || !ss.value) { alert("Categorize!"); return; }
                cat=cs.options[cs.selectedIndex].text; sub=ss.options[ss.selectedIndex].text;
                nat=ss.options[ss.selectedIndex].getAttribute('data-nat'); comp=ss.options[ss.selectedIndex].getAttribute('data-comp');
            }
            db[index].financeiro.push({
                id: Date.now(), data: document.getElementById('lancData').value, tipo: tipo,
                valor: parseFloat(document.getElementById('lancValor').value), descricao: document.getElementById('lancDescricao').value,
                categoria: cat, subcategoria: sub, natureza: nat, comportamento: comp,
                status: document.getElementById('lancStatusRealizado').checked ? 'Realizado' : 'Provisionado'
            });
            saveDB(db);
            bootstrap.Modal.getInstance(document.getElementById('modalLancamento')).hide();
            carregarLancamentos(); if(document.getElementById('view-anual').classList.contains('active')) carregarVisaoAnual();
        }
        function excluirLancamento(id) { if(confirm("Excluir?")) { const db=getDB(); const i=db.findIndex(c=>c.id===clientId); db[i].financeiro=db[i].financeiro.filter(l=>l.id!==id); saveDB(db); carregarLancamentos(); if(document.getElementById('view-anual').classList.contains('active')) carregarVisaoAnual(); } }

        // --- CONFIG CATS (Resumo) ---
        function abrirModalConfig() { renderCats(); document.getElementById('painelSubcat').classList.add('d-none'); document.getElementById('painelSubcatVazio').classList.remove('d-none'); new bootstrap.Modal(document.getElementById('modalConfig')).show(); }
        function renderCats() { 
            const db=getDB(), emp=db.find(c=>c.id===clientId), lst=document.getElementById('listaCategoriasConfig'); lst.innerHTML='';
            emp.configCategorias.forEach((c,i)=>{ lst.innerHTML+=`<button class="list-group-item list-group-item-action d-flex justify-content-between" onclick="selCat(${i})"><span>${c.nome}</span>${!c.isDefault?`<i class="bi bi-trash text-danger" onclick="delCat(event,${i})"></i>`:''}</button>`; });
        }
        function selCat(i) { categoriaEmEdicao=i; const c=getDB().find(x=>x.id===clientId).configCategorias[i]; document.getElementById('catSelecionadaNome').innerText=c.nome; document.getElementById('painelSubcat').classList.remove('d-none'); document.getElementById('painelSubcatVazio').classList.add('d-none'); renderSubs(); }
        function renderSubs() {
            const c=getDB().find(x=>x.id===clientId).configCategorias[categoriaEmEdicao]; const ul=document.getElementById('listaSubcategoriasConfig'); ul.innerHTML='';
            c.subcategorias.forEach((s,i)=>{ ul.innerHTML+=`<li class="list-group-item d-flex justify-content-between"><div>${s.nome} <span class="badge badge-${s.natureza.toLowerCase()}">${s.natureza}</span> <span class="badge badge-${s.comportamento.toLowerCase()}">${s.comportamento}</span></div><i class="bi bi-x-circle text-danger cursor-pointer" onclick="delSub(${i})"></i></li>`; });
        }
        function addCategoria() { const n=document.getElementById('novaCatNome').value; if(n){ const db=getDB(), i=db.findIndex(c=>c.id===clientId); db[i].configCategorias.push({id:Date.now(),nome:n,isDefault:false,subcategorias:[]}); saveDB(db); document.getElementById('novaCatNome').value=''; renderCats(); } }
        function delCat(e,i) { e.stopPropagation(); if(confirm('Apagar?')) { const db=getDB(), idx=db.findIndex(c=>c.id===clientId); db[idx].configCategorias.splice(i,1); saveDB(db); renderCats(); document.getElementById('painelSubcat').classList.add('d-none'); document.getElementById('painelSubcatVazio').classList.remove('d-none'); } }
        function addSubcategoria() { 
            const n=document.getElementById('novaSubNome').value; if(n){ 
            const db=getDB(), i=db.findIndex(c=>c.id===clientId); 
            db[i].configCategorias[categoriaEmEdicao].subcategorias.push({ nome:n, natureza:document.getElementById('novaSubNatureza').value, comportamento:document.getElementById('novaSubComportamento').value });
            saveDB(db); document.getElementById('novaSubNome').value=''; renderSubs(); 
        }}
        function delSub(i) { const db=getDB(), idx=db.findIndex(c=>c.id===clientId); db[idx].configCategorias[categoriaEmEdicao].subcategorias.splice(i,1); saveDB(db); renderSubs(); }
        
        function carregarCategoriasSelect() {
            const sel=document.getElementById('lancCategoria'), db=getDB(), emp=db.find(c=>c.id===clientId); sel.innerHTML='<option value="">Selecione...</option>';
            emp.configCategorias.forEach((c,i)=> sel.innerHTML+=`<option value="${i}">${c.nome}</option>`);
            document.getElementById('lancSubcategoria').innerHTML='<option value="">Selecione Categoria...</option>'; document.getElementById('lancSubcategoria').disabled=true;
        }
        function carregarSubcategoriasSelect() {
            const i=document.getElementById('lancCategoria').value, sub=document.getElementById('lancSubcategoria');
            if(!i){ sub.disabled=true; return; }
            const subs=getDB().find(c=>c.id===clientId).configCategorias[i].subcategorias;
            sub.innerHTML='<option value="">Selecione...</option>'; sub.disabled=false;
            subs.forEach(s=> { const o=document.createElement('option'); o.text=s.nome; o.setAttribute('data-nat',s.natureza); o.setAttribute('data-comp',s.comportamento); sub.add(o); });
        }
    </script>
</body>
</html>