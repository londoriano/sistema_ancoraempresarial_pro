<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxo de Caixa & DRE | Âncora</title>
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* Layout */
        #wrapper { display: flex; width: 100%; }
        #sidebar-wrapper {
            min-height: 100vh; width: 250px; margin-left: -250px;
            background-color: #2c3e50; transition: margin 0.25s ease-out;
            position: fixed; z-index: 1000;
        }
        #sidebar-wrapper .sidebar-heading { padding: 1.5rem; font-size: 1.2rem; color: white; font-weight: bold; }
        #sidebar-wrapper .list-group-item { background-color: transparent; color: rgba(255,255,255,0.7); border: none; padding: 1rem 1.5rem; }
        #sidebar-wrapper .list-group-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        #sidebar-wrapper .list-group-item.active { background-color: #1a252f; color: white; font-weight: bold; border-left: 4px solid #0dcaf0; }
        #page-content-wrapper { width: 100%; margin-left: 0; transition: margin 0.25s ease-out; }
        @media (min-width: 768px) { #sidebar-wrapper { margin-left: 0; } #page-content-wrapper { margin-left: 250px; } }

        /* --- PLANILHA DRE --- */
        .table-responsive-dre {
            width: 100%;
            max-height: 80vh;
            overflow: auto; /* Permite scroll X e Y */
            background: white;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }

        .table-dre { 
            font-size: 0.7rem; 
            border-collapse: separate; 
            border-spacing: 0; 
            min-width: 2500px; /* Largura forçada para scroll */
        }
        
        .table-dre th, .table-dre td { 
            padding: 4px 6px; 
            vertical-align: middle; 
            white-space: nowrap; 
            border-right: 1px solid #e9ecef; 
            border-bottom: 1px solid #e9ecef;
        }

        /* Coluna Fixa (Sticky Left) */
        .sticky-col { 
            position: sticky; left: 0; z-index: 5; 
            background-color: #f8f9fa; 
            border-right: 2px solid #ced4da !important; 
            width: 280px; min-width: 280px; max-width: 280px;
            overflow: hidden; text-overflow: ellipsis;
        }

        /* Headers Fixos (Sticky Top) */
        .table-dre thead tr:nth-child(1) th { position: sticky; top: 0; z-index: 4; }
        .table-dre thead tr:nth-child(2) th { position: sticky; top: 29px; z-index: 4; } 
        
        /* Canto Superior Esquerdo (Cruzamento Sticky) */
        .table-dre thead tr th.sticky-col { z-index: 6; background-color: #e9ecef; }

        /* Estilos de Célula */
        .dre-header-mes { text-align: center; font-weight: bold; background-color: #e9ecef; border-bottom: 2px solid #adb5bd; }
        .dre-sub-header { font-size: 0.65rem; text-align: center; color: #495057; background-color: #f1f3f5; }
        
        .col-valor { text-align: right; width: 90px; font-family: 'Consolas', monospace; font-weight: 600; }
        .col-pct { text-align: right; width: 45px; font-size: 0.65rem; color: #6c757d; background-color: #fdfdfd; }
        .col-pct-desp { background-color: #fff5f5; color: #d63384; } 

        /* Linhas */
        .row-grupo { background-color: #212529 !important; color: white !important; font-weight: bold; text-transform: uppercase; padding-top: 8px; padding-bottom: 8px; }
        .row-cat { background-color: #e9ecef; font-weight: 700; color: #212529; }
        .row-sub { background-color: #fff; color: #495057; }
        .row-total-saidas { background-color: #ced4da !important; font-weight: 800; border-top: 2px solid #6c757d; }
        .row-saldo { background-color: #2c3e50 !important; color: white !important; font-weight: 900; font-size: 0.9rem; border-top: 3px double white; }

        .val-pos { color: #198754; }
        .val-neg { color: #dc3545; }
        .indent-cat { padding-left: 15px !important; }
        .indent-sub { padding-left: 35px !important; font-style: italic; }

        .nav-tabs .nav-link.active { font-weight: bold; border-top: 3px solid #2c3e50; }
        .badge-natureza { font-size: 0.65em; opacity: 0.8; margin-left: 5px; }
        .badge-receita { background-color: #198754; color: white; }
    </style>
</head>
<body>

    <div class="d-flex" id="wrapper">
        <div id="sidebar-wrapper">
            <div class="sidebar-heading"><i class="bi bi-building"></i> Âncora PRO</div>
            <div class="list-group list-group-flush mt-3">
                <a href="#" onclick="irPara('dados_empresa.html')" class="list-group-item list-group-item-action">
                    <i class="bi bi-clipboard-data me-2"></i> Diagnóstico
                </a>
                <a href="#" class="list-group-item list-group-item-action active">
                    <i class="bi bi-cash-stack me-2"></i> Fluxo de Caixa
                </a>
                <a href="#" class="list-group-item list-group-item-action text-muted" style="cursor: not-allowed;">
                    <i class="bi bi-graph-up-arrow me-2"></i> Indicadores
                </a>
                <div class="mt-5 border-top border-secondary pt-3 px-3">
                    <a href="clientes.html" class="btn btn-outline-light w-100 btn-sm">
                        <i class="bi bi-arrow-left"></i> Voltar para Carteira
                    </a>
                </div>
            </div>
        </div>

        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-3 sticky-top shadow-sm">
                <button class="btn btn-primary d-md-none" id="sidebarToggle"><i class="bi bi-list"></i></button>
                <h5 class="ms-3 mb-0 fw-bold text-secondary" id="headerEmpresa">Carregando...</h5>
                <div class="ms-auto d-flex align-items-center gap-2">
                    <button class="btn btn-outline-dark btn-sm" onclick="triggerImport()" title="Importar JSON"><i class="bi bi-upload"></i></button>
                    <input type="file" id="inputFileJson" class="d-none" accept=".json" onchange="processarImportacao(this)">
                    <button class="btn btn-outline-secondary btn-sm" onclick="abrirModalConfig()"><i class="bi bi-gear-fill"></i> Categorias</button>
                    <button class="btn btn-success fw-bold" onclick="abrirModalLancamento()"><i class="bi bi-plus-lg"></i> Novo</button>
                </div>
            </nav>

            <div class="container-fluid py-4 px-4">
                
                <ul class="nav nav-tabs mb-3" id="viewTabs">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-extrato" data-bs-toggle="tab" data-bs-target="#view-extrato">Extrato Mensal</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-anual" data-bs-toggle="tab" data-bs-target="#view-anual" onclick="carregarVisaoAnual()">DRE Gerencial (Anual)</button>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="view-extrato">
                        <div class="d-flex justify-content-end mb-3 align-items-center gap-2">
                            <label class="fw-bold text-muted small">Mês:</label>
                            <input type="month" id="filtroMes" class="form-control form-control-sm" style="width: 150px;" onchange="carregarLancamentos()">
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4"><div class="card shadow-sm border-start border-5 border-success p-3"><h6 class="text-success small fw-bold">RECEITAS</h6><h3 class="fw-bold mb-0 text-success" id="totalReceitas">R$ 0,00</h3></div></div>
                            <div class="col-md-4"><div class="card shadow-sm border-start border-5 border-danger p-3"><h6 class="text-danger small fw-bold">DESPESAS</h6><h3 class="fw-bold mb-0 text-danger" id="totalSaidas">R$ 0,00</h3></div></div>
                            <div class="col-md-4"><div class="card shadow-sm border-start border-5 border-primary p-3"><h6 class="text-primary small fw-bold">SALDO</h6><h3 class="fw-bold mb-0" id="saldoMes">R$ 0,00</h3></div></div>
                        </div>

                        <div class="card shadow-sm border-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr><th class="ps-4">Data</th><th>Descrição</th><th>Categoria > Sub</th><th>Status</th><th class="text-end pe-4">Valor</th><th></th></tr>
                                    </thead>
                                    <tbody id="tabelaLancamentos"></tbody>
                                </table>
                            </div>
                            <div id="emptyState" class="text-center py-5 d-none"><p class="text-muted">Sem lançamentos.</p></div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="view-anual">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white py-2 d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-secondary" onclick="mudarAno(-1)">< Anterior</button>
                                <h5 class="m-0 fw-bold" id="anoVisaoAnual">2026</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="mudarAno(1)">Próximo ></button>
                            </div>
                            
                            <div class="table-responsive-dre">
                                <table class="table-dre">
                                    <thead>
                                        <tr>
                                            <th class="sticky-col dre-header-mes">DEMONSTRATIVO</th>
                                            <th colspan="3" class="dre-header-mes">JAN</th>
                                            <th colspan="3" class="dre-header-mes">FEV</th>
                                            <th colspan="3" class="dre-header-mes">MAR</th>
                                            <th colspan="3" class="dre-header-mes">ABR</th>
                                            <th colspan="3" class="dre-header-mes">MAI</th>
                                            <th colspan="3" class="dre-header-mes">JUN</th>
                                            <th colspan="3" class="dre-header-mes">JUL</th>
                                            <th colspan="3" class="dre-header-mes">AGO</th>
                                            <th colspan="3" class="dre-header-mes">SET</th>
                                            <th colspan="3" class="dre-header-mes">OUT</th>
                                            <th colspan="3" class="dre-header-mes">NOV</th>
                                            <th colspan="3" class="dre-header-mes">DEZ</th>
                                            <th colspan="3" class="dre-header-mes bg-dark text-white">TOTAL</th>
                                        </tr>
                                        <tr>
                                            <th class="sticky-col dre-sub-header text-start ps-3">Conta / Categoria</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header" title="% Receita">%R</th><th class="dre-sub-header" title="% Despesa Total">%D</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header">%R</th><th class="dre-sub-header">%D</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header">%R</th><th class="dre-sub-header">%D</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header">%R</th><th class="dre-sub-header">%D</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header">%R</th><th class="dre-sub-header">%D</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header">%R</th><th class="dre-sub-header">%D</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header">%R</th><th class="dre-sub-header">%D</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header">%R</th><th class="dre-sub-header">%D</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header">%R</th><th class="dre-sub-header">%D</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header">%R</th><th class="dre-sub-header">%D</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header">%R</th><th class="dre-sub-header">%D</th>
                                            <th class="dre-sub-header">R$</th><th class="dre-sub-header">%R</th><th class="dre-sub-header">%D</th>
                                            <th class="dre-sub-header bg-secondary text-white">R$</th><th class="dre-sub-header bg-secondary text-white">%R</th><th class="dre-sub-header bg-secondary text-white">%D</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaAnualBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalLancamento" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">Novo Lançamento</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formLancamento" onsubmit="salvarLancamento(event)"><div class="btn-group w-100 mb-3"><input type="radio" class="btn-check" name="tipoMov" id="tipoReceita" value="Receita" onchange="toggleFormTipo()" checked><label class="btn btn-outline-success" for="tipoReceita">Entrada</label><input type="radio" class="btn-check" name="tipoMov" id="tipoSaida" value="Saida" onchange="toggleFormTipo()"><label class="btn btn-outline-danger" for="tipoSaida">Saída</label></div><div class="row g-2 mb-3"><div class="col-6"><input type="date" id="lancData" class="form-control" required></div><div class="col-6"><input type="number" step="0.01" id="lancValor" class="form-control" required placeholder="R$"></div></div><div class="mb-3"><label>Categoria</label><select id="lancCategoria" class="form-select" onchange="carregarSubcategoriasSelect()" required></select></div><div class="mb-3"><label>Subcategoria</label><select id="lancSubcategoria" class="form-select" disabled required></select></div><div class="mb-3"><input type="text" id="lancDescricao" class="form-control" placeholder="Descrição"></div><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="lancStatusRealizado" checked><label class="form-check-label">Realizado</label></div><button type="submit" class="btn btn-success w-100">SALVAR</button></form></div></div></div>
    </div>

    <div class="modal fade" id="modalConfig" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-secondary text-white"><h5 class="modal-title">Categorias</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body">
            <ul class="nav nav-tabs mb-3" id="configTabs">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cfg-panel" onclick="setTipoConfig('Receita')">Receitas</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#cfg-panel" onclick="setTipoConfig('Saida')">Despesas</button></li>
            </ul>
            <div class="row">
                <div class="col-md-5 border-end">
                    <div class="input-group mb-2"><input type="text" id="novaCatNome" class="form-control form-control-sm"><button class="btn btn-primary btn-sm" onclick="addCategoria()">+</button></div>
                    <div class="list-group overflow-auto" style="max-height:300px" id="listaCategoriasConfig"></div>
                </div>
                <div class="col-md-7">
                    <div id="painelSubcat" class="d-none">
                        <h6 id="catSelecionadaNome" class="fw-bold text-primary"></h6>
                        <div class="card bg-light p-2 mb-3">
                            <input type="text" id="novaSubNome" class="form-control form-control-sm mb-2" placeholder="Nome Sub">
                            <div class="row g-2" id="divClassificacaoSub"><div class="col-6"><select id="novaSubNatureza" class="form-select form-select-sm"><option value="Custo">Custo</option><option value="Despesa">Despesa</option></select></div><div class="col-6"><select id="novaSubComportamento" class="form-select form-select-sm"><option value="Variavel">Variável</option><option value="Fixa">Fixa</option></select></div></div>
                            <button class="btn btn-success btn-sm w-100 mt-2" onclick="addSubcategoria()">Adicionar Sub</button>
                        </div>
                        <ul class="list-group list-group-flush" id="listaSubcategoriasConfig"></ul>
                    </div>
                    <div id="painelSubcatVazio" class="text-center text-muted mt-5">Selecione uma categoria.</div>
                </div>
            </div>
        </div></div></div>
    </div>

    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        const DB_KEY = 'ancora_empresas';
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('id');
        let anoAtualVisao = new Date().getFullYear();
        let categoriaEmEdicao = null;
        let tipoConfigAtual = 'Receita';

        // --- CONSTANTES DE INICIALIZAÇÃO ---
        const DEFAULT_REC = ["Receita Operacional", "Receita Recorrente", "Receita Financeira", "Receita Patrimonial", "Receita Não Operacional", "Outras Receitas"];
        const DEFAULT_SAI = ["Insumos administrativos", "Estrutura básica", "Impostos e taxas", "Recursos Humanos", "Rendimento Sócios/Pró-labore", "Prestadores de serviço", "Banco(s)", "Matéria prima", "Marketing e vendas", "Treinamento e desenvolvimento", "Máquinas e equipamentos", "Transporte/frota/Automóveis"];

        document.addEventListener('DOMContentLoaded', () => {
            if(!clientId) { alert("Erro: ID não fornecido"); return; }
            document.getElementById('sidebarToggle').addEventListener('click', e => { e.preventDefault(); document.body.classList.toggle('sb-sidenav-toggled'); });
            document.getElementById('filtroMes').value = new Date().toISOString().slice(0, 7);
            carregarDadosEmpresa();
        });

        function getDB() { return JSON.parse(localStorage.getItem(DB_KEY)) || []; }
        function saveDB(db) { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        function irPara(pg) { window.location.href = `${pg}?id=${clientId}`; }

        function carregarDadosEmpresa() {
            const db = getDB();
            const index = db.findIndex(c => c.id === clientId);
            if(index === -1) return;
            let empresa = db[index];
            document.getElementById('headerEmpresa').innerText = empresa.empresa;

            // Inicialização Segura
            if(!empresa.financeiro) empresa.financeiro = [];
            
            // Migração/Inicialização de Categorias
            if(!empresa.configCategorias || empresa.configCategorias.length === 0) {
                empresa.configCategorias = [];
                DEFAULT_REC.forEach(n => empresa.configCategorias.push({id:Date.now()+Math.random(), nome:n, tipo:'Receita', isDefault:true, subcategorias:[]}));
                DEFAULT_SAI.forEach(n => empresa.configCategorias.push({id:Date.now()+Math.random(), nome:n, tipo:'Saida', isDefault:true, subcategorias:[]}));
                db[index] = empresa;
                saveDB(db);
            } else {
                // Migração legado (se não tiver tipo)
                let mudou = false;
                empresa.configCategorias.forEach(c => {
                    if(!c.tipo) { c.tipo = 'Saida'; mudou = true; }
                });
                if(mudou) { db[index] = empresa; saveDB(db); }
            }
            carregarLancamentos();
        }

        // --- DRE GERENCIAL ---
        function mudarAno(delta) { anoAtualVisao += delta; carregarVisaoAnual(); }
        
        function carregarVisaoAnual() {
            document.getElementById('anoVisaoAnual').innerText = anoAtualVisao;
            const db = getDB();
            const empresa = db.find(c => c.id === clientId);
            const tbody = document.getElementById('tabelaAnualBody');
            tbody.innerHTML = '';

            const lancs = empresa.financeiro.filter(l => l.data.startsWith(anoAtualVisao.toString()));
            
            const grupos = {
                'RECEITAS': { cats: {}, cor: 'val-pos' },
                'CUSTOS VARIÁVEIS': { cats: {}, cor: 'val-neg' },
                'CUSTOS FIXOS': { cats: {}, cor: 'val-neg' },
                'DESPESAS VARIÁVEIS': { cats: {}, cor: 'val-neg' },
                'DESPESAS FIXAS': { cats: {}, cor: 'val-neg' }
            };

            let recBrutaMes = Array(12).fill(0);
            let despTotalMes = Array(12).fill(0);

            // 1. Processar
            lancs.forEach(l => {
                const mes = parseInt(l.data.split('-')[1]) - 1;
                let gKey = '';
                if(l.tipo === 'Receita') {
                    gKey = 'RECEITAS';
                    recBrutaMes[mes] += l.valor;
                } else {
                    despTotalMes[mes] += l.valor;
                    const nat = l.natureza || 'Despesa';
                    const comp = l.comportamento || 'Fixa';
                    if(nat === 'Custo' && comp === 'Variavel') gKey = 'CUSTOS VARIÁVEIS';
                    else if(nat === 'Custo') gKey = 'CUSTOS FIXOS';
                    else if(nat === 'Despesa' && comp === 'Variavel') gKey = 'DESPESAS VARIÁVEIS';
                    else gKey = 'DESPESAS FIXAS';
                }
                if(!grupos[gKey].cats[l.categoria]) grupos[gKey].cats[l.categoria] = {};
                if(!grupos[gKey].cats[l.categoria][l.subcategoria]) grupos[gKey].cats[l.categoria][l.subcategoria] = Array(12).fill(0);
                grupos[gKey].cats[l.categoria][l.subcategoria][mes] += l.valor;
            });

            // 2. Renderizar
            // Receitas
            renderGrupoDRE('RECEITAS', grupos['RECEITAS'], recBrutaMes, despTotalMes, true);
            // Despesas
            ['CUSTOS VARIÁVEIS', 'CUSTOS FIXOS', 'DESPESAS VARIÁVEIS', 'DESPESAS FIXAS'].forEach(g => {
                renderGrupoDRE(g, grupos[g], recBrutaMes, despTotalMes, false);
            });
            // Total Saídas
            renderLinhaDRE('TOTAL CUSTOS E DESPESAS', despTotalMes, 'row-total-saidas val-neg', true, recBrutaMes, despTotalMes, false);
            // Resultado
            const saldoMes = recBrutaMes.map((v, i) => v - despTotalMes[i]);
            renderLinhaDRE('RESULTADO OPERACIONAL', saldoMes, 'row-saldo', true, recBrutaMes, despTotalMes, true);
        }

        function renderGrupoDRE(gName, grupo, baseRec, baseDesp, isReceita) {
            const temDados = Object.keys(grupo.cats).length > 0;
            if(!temDados && !isReceita) return;
            renderLinhaDRE(gName, Array(12).fill(null), 'row-grupo ' + grupo.cor, false, baseRec, baseDesp, isReceita);
            for(const [cat, subs] of Object.entries(grupo.cats)) {
                let totCat = Array(12).fill(0);
                for(const vals of Object.values(subs)) vals.forEach((v,i) => totCat[i] += v);
                renderLinhaDRE(cat, totCat, `row-cat indent-cat ${grupo.cor}`, true, baseRec, baseDesp, isReceita);
                for(const [sub, vals] of Object.entries(subs)) {
                    renderLinhaDRE(sub, vals, `row-sub indent-sub ${grupo.cor}`, true, baseRec, baseDesp, isReceita);
                }
            }
        }

        function renderLinhaDRE(titulo, valores, classeCSS, calcTotal, baseRec, baseDesp, isReceita) {
            const tbody = document.getElementById('tabelaAnualBody');
            let cols = '';
            let totAno = 0;
            const bR = baseRec || Array(12).fill(0);
            const bD = baseDesp || Array(12).fill(0);
            const totRecAno = bR.reduce((a,b)=>a+b,0);
            const totDespAno = bD.reduce((a,b)=>a+b,0);

            valores.forEach((v, i) => {
                if(v === null) {
                    cols += '<td></td><td></td><td></td>';
                } else {
                    totAno += v;
                    const val = v !== 0 ? v.toLocaleString('pt-BR',{minimumFractionDigits:2}) : '-';
                    const av1 = (bR[i] > 0) ? ((v/bR[i])*100).toFixed(1)+'%' : '-';
                    let av2 = '-';
                    let clsAv2 = 'col-pct';
                    if(!isReceita && bD[i] > 0) {
                        const p = (v/bD[i])*100;
                        if(p > 0) { av2 = p.toFixed(1)+'%'; clsAv2 += ' col-pct-desp'; }
                    }
                    cols += `<td class="col-valor">${val}</td><td class="col-pct">${av1}</td><td class="${clsAv2}">${av2}</td>`;
                }
            });

            let tF='', tA1='', tA2='';
            if(calcTotal && valores[0]!==null) {
                tF = totAno.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
                tA1 = totRecAno > 0 ? ((totAno/totRecAno)*100).toFixed(1)+'%' : '-';
                if(!isReceita && totDespAno > 0) tA2 = ((totAno/totDespAno)*100).toFixed(1)+'%';
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="sticky-col ${classeCSS}">${titulo}</td>${cols}<td class="col-valor bg-secondary text-white border-start border-white">${tF}</td><td class="col-pct bg-secondary text-white border-start border-white">${tA1}</td><td class="col-pct bg-secondary text-white border-start border-white">${tA2}</td>`;
            tbody.appendChild(tr);
        }

        // --- CRUD / CONFIG ---
        function toggleFormTipo() { setTipoConfig(document.querySelector('input[name="tipoMov"]:checked').value); carregarCategoriasSelect(); }
        function abrirModalLancamento() { document.getElementById('formLancamento').reset(); document.getElementById('lancData').valueAsDate=new Date(); document.getElementById('tipoReceita').checked=true; toggleFormTipo(); new bootstrap.Modal(document.getElementById('modalLancamento')).show(); }
        
        function salvarLancamento(e) {
            e.preventDefault(); const db=getDB(), idx=db.findIndex(c=>c.id===clientId);
            const tipo = document.querySelector('input[name="tipoMov"]:checked').value;
            const cs=document.getElementById('lancCategoria'), ss=document.getElementById('lancSubcategoria');
            
            if(!cs.value || !ss.value) { alert("Categorize!"); return; }
            const cat = cs.options[cs.selectedIndex].text;
            const sub = ss.options[ss.selectedIndex].text;
            let nat='-', comp='-';
            if(tipo==='Saida') {
                nat = ss.options[ss.selectedIndex].getAttribute('data-nat');
                comp = ss.options[ss.selectedIndex].getAttribute('data-comp');
            }

            db[idx].financeiro.push({
                id:Date.now(), data:document.getElementById('lancData').value, tipo:tipo,
                valor:parseFloat(document.getElementById('lancValor').value),
                categoria:cat, subcategoria:sub, natureza:nat, comportamento:comp,
                descricao:document.getElementById('lancDescricao').value,
                status:document.getElementById('lancStatusRealizado').checked?'Realizado':'Provisionado'
            });
            saveDB(db); bootstrap.Modal.getInstance(document.getElementById('modalLancamento')).hide();
            carregarLancamentos(); if(document.getElementById('view-anual').classList.contains('active')) carregarVisaoAnual();
        }

        function excluirLancamento(id) { if(confirm("Excluir?")){const db=getDB(),i=db.findIndex(c=>c.id===clientId);db[i].financeiro=db[i].financeiro.filter(l=>l.id!==id);saveDB(db);carregarLancamentos();carregarVisaoAnual();}}

        // Config Categorias
        function setTipoConfig(t) {
            tipoConfigAtual = t;
            document.getElementById('divClassificacaoSub').style.display = t==='Receita'?'none':'flex';
            document.getElementById('painelSubcat').classList.add('d-none');
            document.getElementById('painelSubcatVazio').classList.remove('d-none');
            renderConfigCats();
        }
        function abrirModalConfig() {
            const tabBtn = document.querySelector('#configTabs button[data-bs-target="#cfg-panel"]');
            if(tabBtn) bootstrap.Tab.getOrCreateInstance(tabBtn).show();
            setTipoConfig('Receita');
            new bootstrap.Modal(document.getElementById('modalConfig')).show();
        }
        function renderConfigCats() {
            const lst=document.getElementById('listaCategoriasConfig'); lst.innerHTML='';
            getDB().find(c=>c.id===clientId).configCategorias.filter(c=>c.tipo===tipoConfigAtual).forEach(c=>{
                const icone = c.isDefault ? '<i class="bi bi-lock-fill text-muted"></i>' : `<i class="bi bi-trash text-danger" onclick="delConfigCat(event,${c.id})"></i>`;
                lst.innerHTML += `<button class="list-group-item list-group-item-action d-flex justify-content-between" onclick="selConfigCat(${c.id})"><span>${c.nome}</span>${icone}</button>`;
            });
        }
        function selConfigCat(id) {
            categoriaEmEdicao = id;
            const c = getDB().find(x=>x.id===clientId).configCategorias.find(x=>x.id==id);
            document.getElementById('painelSubcat').classList.remove('d-none');
            document.getElementById('painelSubcatVazio').classList.add('d-none');
            document.getElementById('catSelecionadaNome').innerText = c.nome;
            renderConfigSubs(c);
        }
        function renderConfigSubs(c) {
            const ul=document.getElementById('listaSubcategoriasConfig'); ul.innerHTML='';
            c.subcategorias.forEach((s,i)=>{
                let bdg=''; if(c.tipo==='Saida') bdg = `<small class="badge bg-secondary ms-2">${s.natureza}</small><small class="badge bg-light text-dark border ms-1">${s.comportamento}</small>`;
                ul.innerHTML+=`<li class="list-group-item d-flex justify-content-between"><div>${s.nome} ${bdg}</div><i class="bi bi-x-circle text-danger cursor-pointer" onclick="delConfigSub(${i})"></i></li>`;
            });
        }
        function addCategoria() {
            const n=document.getElementById('novaCatNome').value; if(!n)return;
            const db=getDB(), i=db.findIndex(c=>c.id===clientId);
            db[i].configCategorias.push({id:Date.now(), nome:n, tipo:tipoConfigAtual, isDefault:false, subcategorias:[]});
            saveDB(db); document.getElementById('novaCatNome').value=''; renderConfigCats();
        }
        function delConfigCat(e,id) { e.stopPropagation(); if(confirm('Excluir?')){const db=getDB(),i=db.findIndex(c=>c.id===clientId);db[i].configCategorias=db[i].configCategorias.filter(c=>c.id!==id);saveDB(db);renderConfigCats();document.getElementById('painelSubcat').classList.add('d-none');}}
        function addSubcategoria() {
            const n=document.getElementById('novaSubNome').value; if(!n)return;
            const db=getDB(), i=db.findIndex(c=>c.id===clientId);
            const cat=db[i].configCategorias.find(c=>c.id==categoriaEmEdicao);
            const nova={nome:n};
            if(tipoConfigAtual==='Saida'){ nova.natureza=document.getElementById('novaSubNatureza').value; nova.comportamento=document.getElementById('novaSubComportamento').value; }
            cat.subcategorias.push(nova); saveDB(db); document.getElementById('novaSubNome').value=''; renderConfigSubs(cat);
        }
        function delConfigSub(idx){ const db=getDB(),i=db.findIndex(c=>c.id===clientId), cat=db[i].configCategorias.find(c=>c.id==categoriaEmEdicao); cat.subcategorias.splice(idx,1); saveDB(db); renderConfigSubs(cat); }

        function carregarCategoriasSelect() {
            const sel=document.getElementById('lancCategoria'), sub=document.getElementById('lancSubcategoria');
            const tipo=document.querySelector('input[name="tipoMov"]:checked').value;
            sel.innerHTML='<option value="">Selecione...</option>'; sub.innerHTML='<option value="">Selecione...</option>'; sub.disabled=true;
            getDB().find(c=>c.id===clientId).configCategorias.filter(c=>c.tipo===tipo).forEach(c=> sel.innerHTML+=`<option value="${c.id}">${c.nome}</option>`);
        }
        function carregarSubcategoriasSelect() {
            const id=document.getElementById('lancCategoria').value, sub=document.getElementById('lancSubcategoria');
            if(!id){sub.disabled=true;return;}
            const c=getDB().find(x=>x.id===clientId).configCategorias.find(x=>x.id==id);
            sub.innerHTML='<option value="">Selecione...</option>'; sub.disabled=false;
            c.subcategorias.forEach(s=> { const o=document.createElement('option'); o.text=s.nome; if(c.tipo==='Saida'){ o.setAttribute('data-nat',s.natureza); o.setAttribute('data-comp',s.comportamento); } sub.add(o); });
        }
        function triggerImport(){ document.getElementById('inputFileJson').click(); }
        function processarImportacao(input){
            if(!input.files.length)return;
            const r=new FileReader(); r.onload=e=>{ try{
                const d=JSON.parse(e.target.result), db=getDB(), i=db.findIndex(c=>c.id===clientId);
                d.forEach(x=> db[i].financeiro.push({id:Date.now()+Math.random(), data:x.data, tipo:x.tipo, valor:parseFloat(x.valor), categoria:x.categoria||'-', subcategoria:x.subcategoria||'-', natureza:x.natureza||'-', comportamento:x.comportamento||'-', descricao:x.descricao||'Imp', status:'Realizado'}));
                saveDB(db); alert('OK'); carregarLancamentos();
            }catch(err){alert('JSON Inválido');}}; r.readAsText(input.files[0]);
        }
        
        // Extrato
        function carregarLancamentos() {
            const db=getDB(), emp=db.find(c=>c.id===clientId), mes=document.getElementById('filtroMes').value;
            const tb=document.getElementById('tabelaLancamentos'); tb.innerHTML='';
            const fs=emp.financeiro.filter(l=>l.data.startsWith(mes));
            let r=0, s=0;
            if(fs.length===0) document.getElementById('emptyState').classList.remove('d-none');
            else {
                document.getElementById('emptyState').classList.add('d-none'); fs.sort((a,b)=>new Date(b.data)-new Date(a.data));
                fs.forEach(l=>{
                    if(l.tipo==='Receita')r+=l.valor; else s+=l.valor;
                    const bTipo=l.tipo==='Receita'?'<span class="badge badge-receita">Receita</span>':`<span class="badge bg-secondary badge-natureza">${l.natureza}</span>`;
                    const cor=l.tipo==='Receita'?'text-success':'text-danger';
                    tb.innerHTML+=`<tr><td class="ps-4">${l.data.split('-').reverse().join('/')}</td><td class="fw-bold text-dark">${l.descricao}</td><td><small class="d-block text-muted">${l.categoria}</small>${l.subcategoria}</td><td>${bTipo}</td><td class="text-end pe-4 fw-bold ${cor}">${l.tipo==='Saida'?'-':''} ${l.valor.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td><td class="text-end"><i class="bi bi-trash text-danger cursor-pointer" onclick="excluirLancamento(${l.id})"></i></td></tr>`;
                });
            }
            document.getElementById('totalReceitas').innerText = r.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('totalSaidas').innerText = s.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            const sal=r-s; document.getElementById('saldoMes').innerText = sal.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('saldoMes').className = `fw-bold mb-0 ${sal>=0?'text-success':'text-danger'}`;
        }
    </script>
</body>
</html>