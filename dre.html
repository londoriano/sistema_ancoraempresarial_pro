<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRE Gerencial | Âncora</title>
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* Layout */
        #wrapper { display: flex; width: 100%; }
        #sidebar-wrapper {
            min-height: 100vh; width: 250px; margin-left: -250px;
            background-color: #2c3e50; transition: margin 0.25s ease-out;
            position: fixed; z-index: 1000;
        }
        #sidebar-wrapper .sidebar-heading { padding: 1.5rem; font-size: 1.2rem; color: white; font-weight: bold; }
        #sidebar-wrapper .list-group-item { background-color: transparent; color: rgba(255,255,255,0.7); border: none; padding: 1rem 1.5rem; }
        #sidebar-wrapper .list-group-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        #sidebar-wrapper .list-group-item.active { background-color: #1a252f; color: white; font-weight: bold; border-left: 4px solid #0dcaf0; }
        #page-content-wrapper { width: 100%; margin-left: 0; transition: margin 0.25s ease-out; }
        @media (min-width: 768px) { #sidebar-wrapper { margin-left: 0; } #page-content-wrapper { margin-left: 250px; } }

        /* Estilos DRE Tabela */
        .card-dre { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .table-dre { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .table-dre th, .table-dre td { padding: 5px 10px; border-bottom: 1px solid #f1f3f5; vertical-align: middle; }
        .table-dre thead th { border-bottom: 2px solid #dee2e6; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- CORES DE VALORES (Forçamos a prioridade) --- */
        .val-entrada { color: #198754 !important; font-weight: 600; } 
        .val-saida { color: #dc3545 !important; font-weight: 600; }   
        
        /* --- LINHAS DE RESULTADO --- */
        .res-receita-bruta { background-color: #e8f1f8; color: #0d47a1; font-weight: 800; border-top: 2px solid #0d47a1; }
        .res-receita-liq { background-color: #e0f2f1; color: #00695c; font-weight: 800; border-top: 1px solid #80cbc4; }
        .res-lucro-bruto { background-color: #fff8e1; color: #e65100; font-weight: 800; border-top: 2px solid #ffb300; }
        .res-ebitda { background-color: #f3e5f5; color: #4a148c; font-weight: 800; border-top: 2px solid #8e24aa; font-size: 1.05rem; }
        .res-ebit { background-color: #e8eaf6; color: #283593; font-weight: 700; border-top: 1px solid #9fa8da; }
        .res-lair { background-color: #efebe9; color: #4e342e; font-weight: 700; }
        .res-final-lucro { background-color: #198754; color: white !important; font-weight: 900; font-size: 1.2rem; border-top: 4px double white; }
        .res-final-preju { background-color: #dc3545; color: white !important; font-weight: 900; font-size: 1.2rem; border-top: 4px double white; }
        
        /* Linhas Comuns */
        .dre-cat-row { 
            font-size: 0.75rem; 
            color: #495057; 
            font-weight: 600; 
            background-color: #fff; 
        }
        /* Aplica opacidade apenas na descrição, não no valor, para não apagar a cor */
        .dre-cat-row td:first-child { opacity: 0.6; } 

        /* Linha de Subcategoria */
        .dre-sub-row { 
            font-size: 0.8rem; 
            color: #6c757d; 
            background-color: #fff; 
        }

        /* Cabeçalho da Categoria (Apenas Título, sem valor) */
        .dre-cat-header { 
            font-size: 0.85rem; 
            color: #212529; 
            font-weight: 700; 
            background-color: #fff; 
            border-bottom: 1px dashed #f1f3f5;
            padding-top: 10px !important; /* Espaço extra para separar grupos */
        }

        /* Rodapé de Total da Categoria (Fonte menor e opacidade) */
        .dre-cat-total { 
            font-size: 0.75rem; 
            color: #495057; 
            font-weight: 700; 
            opacity: 0.6; /* O visual "apagado" que você pediu */
            background-color: #f8f9fa; 
            border-top: 1px solid #e9ecef;
            font-style: italic;
        }

        /* Ajuste de Colunas */
        .col-valor { text-align: right; font-family: 'Consolas', monospace; width: 300px; } /* Aumentei um pouco para caber o sinal */
        .col-av { text-align: right; width: 80px; font-size: 0.8em; color: #adb5bd; }
        .indent-0 { padding-left: 10px !important; }
        .indent-cat { padding-left: 25px !important; }
        .indent-sub { padding-left: 45px !important; }

        /* --- ESTILOS DE IMPRESSÃO (PDF LIMPO) --- */
        @media print {
            /* 1. Remove cabeçalhos e rodapés automáticos do navegador (Data/URL) */
            @page { 
                margin: 0; 
                size: auto; 
            }

            /* 2. Adiciona margem manual ao conteúdo para não colar na borda do papel */
            body { 
                margin: 1.5cm 1cm !important; 
                background-color: white !important;
                -webkit-print-color-adjust: exact !important; /* Força impressão de cores de fundo */
                print-color-adjust: exact !important;
            }

            /* 3. Esconde Sidebar, Navbar, Botões e Ícones */
            #sidebar-wrapper, 
            .navbar, 
            .btn, 
            .bi-trash, 
            .modal { 
                display: none !important; 
            }

            /* 4. Expande o conteúdo para usar a folha toda */
            #page-content-wrapper { 
                margin-left: 0 !important; 
                width: 100% !important; 
                padding: 0 !important;
            }
            
            .container-fluid { padding: 0 !important; }
            .card { border: none !important; box-shadow: none !important; }
            .card-header { background-color: white !important; border-bottom: 2px solid #000 !important; }
            
            /* Ajuste de fonte para caber melhor no papel A4 */
            .table-dre { font-size: 0.8rem !important; }
            .dre-cat-header { background-color: #eee !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="d-flex" id="wrapper">
        <div id="sidebar-wrapper">
            <div class="sidebar-heading"><i class="bi bi-building"></i> Âncora PRO</div>
            <div class="list-group list-group-flush mt-3">
                <a href="#" onclick="irPara('dados_empresa.html')" class="list-group-item list-group-item-action">
                    <i class="bi bi-clipboard-data me-2"></i> Diagnóstico
                </a>
                <a href="#" onclick="irPara('fluxo_caixa.html')" class="list-group-item list-group-item-action">
                    <i class="bi bi-cash-stack me-2"></i> Fluxo de Caixa
                </a>
                <a href="#" class="list-group-item list-group-item-action active">
                    <i class="bi bi-file-earmark-spreadsheet me-2"></i> DRE Gerencial
                </a>
                <div class="mt-5 border-top border-secondary pt-3 px-3">
                    <a href="clientes.html" class="btn btn-outline-light w-100 btn-sm">
                        <i class="bi bi-arrow-left"></i> Voltar para Carteira
                    </a>
                </div>
            </div>
        </div>

        <div id="page-content-wrapper">

            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-3 sticky-top shadow-sm">
                <button class="btn btn-primary d-md-none" id="sidebarToggle"><i class="bi bi-list"></i></button>
                <h5 class="ms-3 mb-0 fw-bold text-secondary" id="headerEmpresa">Carregando...</h5>
                <div class="ms-auto d-flex align-items-center gap-2">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light">De</span>
                        <input type="month" id="mesInicio" class="form-control">
                        <span class="input-group-text bg-light">Até</span>
                        <input type="month" id="mesFim" class="form-control">
                        <button class="btn btn-primary fw-bold" onclick="gerarDRE()">
                            <i class="bi bi-filter"></i> Filtrar
                        </button>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm ms-2" onclick="abrirModalImpostos()">
                        <i class="bi bi-gear-fill"></i> Config. IR/CSLL
                    </button>
                    <button class="btn btn-outline-dark btn-sm" onclick="window.print()">
                        <i class="bi bi-printer"></i>
                    </button>
                </div>
            </nav>

            <div class="container-fluid py-4 px-4">
                
                <div class="card card-dre">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-table"></i> Demonstrativo do Resultado</h5>
                        <p class="mb-0 small text-muted">Regime de Competência | Estrutura: Receita - Custos = Lucro Bruto - Despesas = Operacional</p>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table-dre">
                                <thead>
                                    <tr class="bg-light">
                                        <th class="ps-3">DESCRIÇÃO DA CONTA</th>
                                        <th class="col-valor">VALOR (R$)</th>
                                        <th class="col-av">AV %</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaDreBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="modalImpostos" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title">Configurar Tributos e Créditos</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Defina alíquotas (%) ou créditos nominais (R$).</p>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-12">
                            <label class="small fw-bold">Nome do Tributo</label>
                            <input type="text" id="novoImpNome" class="form-control form-control-sm" placeholder="Ex: Simples Nacional">
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold">Tipo / Base</label>
                            <select id="novoImpTipo" class="form-select form-select-sm" onchange="toggleInputTipo()">
                                <option value="receita">(-) % Sobre Receita Bruta</option>
                                <option value="lucro">(-) % Sobre Lucro (LAIR)</option>
                                <option value="credito_pis">(+) Crédito PIS (R$ Fixo)</option>
                                <option value="credito_cofins">(+) Crédito COFINS (R$ Fixo)</option>
                                <option value="credito_outros">(+) Outro Crédito (R$ Fixo)</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <label class="small fw-bold">Valor</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text" id="spanSifrao" style="display:none">R$</span>
                                <input type="number" id="novoImpValor" class="form-control" placeholder="0.00" step="0.01">
                                <span class="input-group-text" id="spanPorcent">%</span>
                            </div>
                        </div>
                        <div class="col-3 d-flex align-items-end">
                            <button class="btn btn-primary btn-sm w-100" onclick="addImposto()">Add</button>
                        </div>
                    </div>

                    <div class="table-responsive border rounded" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm mb-0 small">
                            <thead class="bg-light">
                                <tr>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th class="text-end">Valor</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="listaImpostos">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        const DB_KEY = 'ancora_empresas';
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('id');

        document.addEventListener('DOMContentLoaded', () => {
            if(!clientId) { alert("Empresa não selecionada."); window.location.href='clientes.html'; return; }
            document.getElementById('sidebarToggle').addEventListener('click', e => { e.preventDefault(); document.body.classList.toggle('sb-sidenav-toggled'); });
            
            // Define Mês Atual como Padrão
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            document.getElementById('mesInicio').value = `${ano}-${mes}`;
            document.getElementById('mesFim').value = `${ano}-${mes}`;

            carregarDados();
        });

        function getDB() { return JSON.parse(localStorage.getItem(DB_KEY)) || []; }
        // --- ADICIONE ESTA FUNÇÃO QUE ESTÁ FALTANDO ---
        function saveDB(db) { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        // ----------------------------------------------
        function irPara(pg) { window.location.href = `${pg}?id=${clientId}`; }

        function carregarDados() {
            const db = getDB();
            const empresa = db.find(c => c.id === clientId);
            if(empresa) document.getElementById('headerEmpresa').innerText = empresa.empresa;
            gerarDRE();
        }

        // --- GERENCIAMENTO DE IMPOSTOS ---
        function abrirModalImpostos() {
            renderListaImpostos();
            new bootstrap.Modal(document.getElementById('modalImpostos')).show();
        }

        // --- FUNÇÕES AUXILIARES DO MODAL ---
        
        function toggleInputTipo() {
            const tipo = document.getElementById('novoImpTipo').value;
            const isCredito = tipo.includes('credito');
            
            // Alterna visualmente entre % e R$
            if (isCredito) {
                document.getElementById('spanSifrao').style.display = 'inline-block';
                document.getElementById('spanPorcent').style.display = 'none';
                document.getElementById('novoImpValor').placeholder = "0.00";
                
                // Sugere nomes se estiver vazio
                const inputNome = document.getElementById('novoImpNome');
                if(!inputNome.value) {
                    if(tipo === 'credito_pis') inputNome.value = 'Crédito PIS';
                    else if(tipo === 'credito_cofins') inputNome.value = 'Crédito COFINS';
                }
            } else {
                document.getElementById('spanSifrao').style.display = 'none';
                document.getElementById('spanPorcent').style.display = 'inline-block';
                document.getElementById('novoImpValor').placeholder = "Aliq %";
            }
        }

        function addImposto() {
            const nome = document.getElementById('novoImpNome').value;
            const tipo = document.getElementById('novoImpTipo').value;
            const valor = parseFloat(document.getElementById('novoImpValor').value);
            
            if(!nome || isNaN(valor)) { alert("Preencha corretamente."); return; }

            const db = getDB();
            const idx = db.findIndex(c => c.id === clientId);
            
            if(!db[idx].configImpostos) db[idx].configImpostos = [];
            
            db[idx].configImpostos.push({ 
                id: Date.now(), 
                nome, 
                tipo, 
                valor: valor // Agora representa % ou R$ dependendo do tipo
            });
            saveDB(db);
            
            document.getElementById('novoImpNome').value = '';
            document.getElementById('novoImpValor').value = '';
            renderListaImpostos();
            gerarDRE(); 
        }

        function renderListaImpostos() {
            const db = getDB();
            const empresa = db.find(c => c.id === clientId);
            const tbody = document.getElementById('listaImpostos');
            tbody.innerHTML = '';
            
            const impostos = empresa.configImpostos || [];
            
            if(impostos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted p-3">Nenhum tributo configurado.</td></tr>';
                return;
            }

            impostos.forEach((imp, i) => {
                let badge = '';
                let valDisplay = '';
                
                if(imp.tipo === 'receita') {
                    badge = '<span class="badge bg-warning text-dark">(-) S/ Receita</span>';
                    valDisplay = imp.valor + '%';
                } else if(imp.tipo === 'lucro') {
                    badge = '<span class="badge bg-dark">(-) S/ Lucro</span>';
                    valDisplay = imp.valor + '%';
                } else {
                    badge = '<span class="badge bg-success">(+) Crédito</span>';
                    valDisplay = imp.valor.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                }

                tbody.innerHTML += `
                    <tr>
                        <td class="align-middle">${imp.nome}</td>
                        <td class="align-middle">${badge}</td>
                        <td class="align-middle text-end fw-bold">${valDisplay}</td>
                        <td class="align-middle text-end">
                            <i class="bi bi-trash text-danger cursor-pointer" onclick="delImposto(${i})"></i>
                        </td>
                    </tr>
                `;
            });
        }

        function delImposto(idx) {
            const db = getDB();
            const i = db.findIndex(c => c.id === clientId);
            db[i].configImpostos.splice(idx, 1);
            saveDB(db);
            renderListaImpostos();
            gerarDRE();
        }

       function gerarDRE() {
            const db = getDB();
            const empresa = db.find(c => c.id === clientId);
            if(!empresa || !empresa.financeiro) return;

            const inicio = document.getElementById('mesInicio').value;
            const fim = document.getElementById('mesFim').value;

            const lancs = empresa.financeiro.filter(l => {
                const dataConsiderada = l.dataCompetencia || l.data;
                return dataConsiderada.slice(0, 7) >= inicio && dataConsiderada.slice(0, 7) <= fim;
            });

            let DRE = {
                receitaBruta: 0, deducoes: 0, custosTotais: 0, despesasTotais: 0, 
                receitaFin: 0, despesaFin: 0, depreciacao: 0,
                detalhes: { rec: {}, ded: {}, custos: {}, desp: {}, rf: {}, dfn: {}, dep: {} }
            };

            // --- FUNÇÕES AUXILIARES INTERNAS (Corrigindo o erro 'R is not defined') ---
            
            // 1. Renderiza Linha Individual (R)
            const R = (desc, val, estilo = '', nivel = 0, forceRed = false) => {
                // Tratamento para Títulos de Categoria (Sem Valor)
                if (val === null) {
                    let indent = nivel === 1 ? 'indent-cat' : 'indent-0';
                    return `<tr class="${estilo}"><td class="${indent}" colspan="3">${desc}</td></tr>`;
                }

                // Cálculo de AV% (Agora seguro pois acessa a variavel DRE local)
                const av = (DRE.receitaBruta > 0) ? (val / DRE.receitaBruta * 100).toFixed(1) + '%' : '-';
                
                let indentClass = nivel === 1 ? 'indent-cat' : (nivel === 2 ? 'indent-sub' : 'indent-0');
                let corVal = 'text-dark';
                let sinal = '';

                // Lógica Visual
                if (estilo.includes('res-final')) {
                    corVal = 'text-white';
                    sinal = val >= 0 ? '+ ' : ''; 
                } else {
                    if (desc.includes('(-)') || desc.includes('Imposto') || desc.includes('Custo') || desc.includes('Despesa') || forceRed) {
                        corVal = 'val-saida';
                        sinal = '- ';
                    } else if (val >= 0) {
                        corVal = 'val-entrada';
                        sinal = '+ ';
                    }
                }

                let valNumerico = Math.abs(val).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                let valFinal = `${sinal}R$ ${valNumerico}`;

                // Ajuste para exibição de prejuízo na linha final
                if (estilo.includes('res-final') && val < 0) {
                    valFinal = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                }

                return `<tr class="${estilo}"><td class="${indentClass}">${desc}</td><td class="col-valor ${corVal}">${valFinal}</td><td class="col-av">${desc.includes('AV') ? '' : av}</td></tr>`;
            };

            // 2. Renderiza Grupos (RenderGroup)
            const RenderGroup = (objDetalhes, isExpense = false) => {
                let html = '';
                for(let [cat, info] of Object.entries(objDetalhes)) {
                    // Título
                    html += R(cat, null, 'dre-cat-header', 1, isExpense);
                    // Itens
                    for(let [sub, sVal] of Object.entries(info.subs)) {
                        html += R(sub, sVal, 'dre-sub-row', 2, isExpense);
                    }
                    // Total
                    html += R(`Total ${cat}`, info.total, 'dre-cat-total', 1, isExpense);
                }
                return html;
            };

            // --- FIM DAS FUNÇÕES AUXILIARES ---


            // 1. CLASSIFICAÇÃO DOS DADOS
            lancs.forEach(l => {
                const val = l.valor;
                const cat = l.categoria; 
                const sub = l.subcategoria || '-';
                const catLower = cat.toLowerCase();
                
                if (l.tipo === 'Receita') {
                    if (catLower.includes('financeira') || catLower.includes('aplicação')) {
                        DRE.receitaFin += val;
                        addDetalhe(DRE.detalhes.rf, cat, sub, val);
                    } else {
                        DRE.receitaBruta += val;
                        addDetalhe(DRE.detalhes.rec, cat, sub, val);
                    }
                } 
                else { // SAÍDAS
                    // A. Juros Específicos
                    if (l.valorJuros && l.valorJuros > 0) {
                        DRE.despesaFin += l.valorJuros;
                        addDetalhe(DRE.detalhes.dfn, cat, sub, l.valorJuros);
                        return; 
                    }

                    // B. IGNORAR IMPOSTOS DO CAIXA (Para usar o cálculo automático)
                    if (catLower.includes('imposto') || catLower.includes('simples') || catLower.includes('taxas')) {
                        return; 
                    }

                    // C. Outros
                    if (catLower.includes('banco') || catLower.includes('juros') || catLower.includes('financeira')) {
                        DRE.despesaFin += val;
                        addDetalhe(DRE.detalhes.dfn, cat, sub, val);
                    }
                    else if (catLower.includes('depreciação') || catLower.includes('amortização')) {
                        DRE.depreciacao += val;
                        addDetalhe(DRE.detalhes.dep, cat, sub, val);
                    }
                    else {
                        const nat = l.natureza || 'Despesa';
                        if (nat === 'Custo') {
                            DRE.custosTotais += val;
                            addDetalhe(DRE.detalhes.custos, cat, sub, val);
                        } else {
                            DRE.despesasTotais += val;
                            addDetalhe(DRE.detalhes.desp, cat, sub, val);
                        }
                    }
                }
            });

            // 2. CÁLCULO DE TRIBUTOS E CRÉDITOS
            const configImpostos = empresa.configImpostos || [];
            const impsReceita = configImpostos.filter(i => i.tipo === 'receita');
            const impsCredito = configImpostos.filter(i => i.tipo.includes('credito')); 
            const impsLucro   = configImpostos.filter(i => i.tipo === 'lucro');

            // 2.1 Impostos s/ Receita (%)
            let htmlImpostosVenda = '';
            let totalImpVendaCalc = 0;
            
            impsReceita.forEach(imp => {
                const valCalc = DRE.receitaBruta * (imp.valor / 100);
                totalImpVendaCalc += valCalc;
                htmlImpostosVenda += renderLinhaSimples(imp.nome + ` (${imp.valor}%)`, valCalc, 'dre-sub-row indent-sub', false);
            });
            DRE.deducoes += totalImpVendaCalc;

            // 2.2 Créditos (Valores Nominais R$)
            let htmlCreditos = '';
            let totalCreditosCalc = 0;

            impsCredito.forEach(imp => {
                const valCredito = imp.valor; 
                totalCreditosCalc += valCredito;
                htmlCreditos += renderLinhaSimples(`(+) ${imp.nome}`, valCredito, 'dre-sub-row indent-sub', true); // true = positivo
            });
            DRE.deducoes -= totalCreditosCalc;


            // --- CÁLCULO DOS RESULTADOS ---
            const receitaLiquida = DRE.receitaBruta - DRE.deducoes;
            const lucroBruto = receitaLiquida - DRE.custosTotais;
            const ebitda = lucroBruto - DRE.despesasTotais;
            const ebit = ebitda - DRE.depreciacao;
            const resFinanceiro = DRE.receitaFin - DRE.despesaFin;
            const lair = ebit + resFinanceiro;

            // 2.3 Impostos s/ Lucro (%)
            let totalImpostosLucro = 0;
            let htmlImpostosLucro = '';

            if (lair > 0 && impsLucro.length > 0) {
                impsLucro.forEach(imp => {
                    const valorImp = lair * (imp.valor / 100);
                    totalImpostosLucro += valorImp;
                    htmlImpostosLucro += renderLinhaSimples(imp.nome + ` (${imp.valor}%)`, valorImp, 'dre-sub-row indent-sub', false);
                });
            }
            const lucroLiquido = lair - totalImpostosLucro;


            // --- RENDERIZAÇÃO HTML ---
            const tbody = document.getElementById('tabelaDreBody');
            tbody.innerHTML = '';
            let html = '';

            // 1. Receita
            html += R('(=) RECEITA BRUTA OPERACIONAL', DRE.receitaBruta, 'res-receita-bruta');
            html += RenderGroup(DRE.detalhes.rec, false);
            
            // 2. Deduções
            html += R('(-) Deduções e Impostos', null, 'text-muted fw-bold mb-2'); 
            
            // Renderiza Calculados Automaticamente
            if(totalImpVendaCalc > 0) {
                html += R('Impostos s/ Venda', null, 'dre-cat-header', 1);
                html += htmlImpostosVenda;
                html += R('Total Impostos', totalImpVendaCalc, 'dre-cat-total', 1, true);
            }

            if(totalCreditosCalc > 0) {
                html += R('Créditos Tributários', null, 'dre-cat-header', 1);
                html += htmlCreditos;
                html += R('Total Créditos', totalCreditosCalc, 'dre-cat-total text-success', 1, false);
            }
            
            // Ded. Manuais (Se houver alguma que escapou do filtro, embora tenhamos bloqueado 'imposto')
            html += RenderGroup(DRE.detalhes.ded, true);

            html += R('(=) Total Deduções Líquidas', DRE.deducoes, 'dre-cat-total', 0, true);

            // 3. Resto do DRE
            html += R('(=) RECEITA LÍQUIDA', receitaLiquida, 'res-receita-liq');
            
            html += R('(-) Custos Operacionais', DRE.custosTotais, 'text-muted fw-bold');
            html += RenderGroup(DRE.detalhes.custos, true);

            html += R('(=) LUCRO BRUTO', lucroBruto, 'res-lucro-bruto');
            
            html += R('(-) Despesas Operacionais', DRE.despesasTotais, 'text-muted fw-bold');
            html += RenderGroup(DRE.detalhes.desp, true);
            
            html += '<tr><td colspan="3" class="bg-light p-1"></td></tr>';

            html += R('(=) EBITDA (Lajida)', ebitda, 'res-ebitda');
            
            if(DRE.depreciacao > 0) {
                html += R('(-) Depreciação / Amortização', DRE.depreciacao, 'text-muted fw-bold');
                html += RenderGroup(DRE.detalhes.dep, true);
            }
            
            html += R('(=) EBIT (Resultado Operacional)', ebit, 'res-ebit');

            if(DRE.receitaFin > 0 || DRE.despesaFin > 0) {
                html += '<tr><td colspan="3" class="fw-bold text-muted mt-2 border-0 small ps-3">Resultado Financeiro</td></tr>';
                if(DRE.receitaFin > 0) { html += R('(+) Receitas Financeiras', DRE.receitaFin, 'text-success'); html += RenderGroup(DRE.detalhes.rf, false); }
                if(DRE.despesaFin > 0) { html += R('(-) Despesas Financeiras', DRE.despesaFin, 'text-danger'); html += RenderGroup(DRE.detalhes.dfn, true); }
            }
            
            html += R('(=) LAIR (Lucro Antes do IR)', lair, 'res-lair');

            if (totalImpostosLucro > 0) {
                html += R('(-) IR e Contribuição Social', totalImpostosLucro, 'text-muted fw-bold');
                html += htmlImpostosLucro; 
            }

            const classeFinal = lucroLiquido >= 0 ? 'res-final-lucro' : 'res-final-preju';
            const labelFinal = lucroLiquido >= 0 ? '(=) LUCRO LÍQUIDO DO PERÍODO' : '(=) PREJUÍZO LÍQUIDO DO PERÍODO';
            html += R(labelFinal, lucroLiquido, classeFinal);

            tbody.innerHTML = html;
        }

        // --- FUNÇÕES DE RENDERIZAÇÃO (REINCLUINDO PARA GARANTIR) ---
        // Certifique-se que estas funções (RenderGroup e R) estejam presentes e NÃO duplicadas.
        // A lógica do 'R' deve ser a mesma da última correção (com tratamento de null).

        // Helper renderLinhaSimples (Atualizado para suportar positivo/verde)
        function renderLinhaSimples(desc, val, classes, isPositive) {
            let valFormat = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            let corVal = isPositive ? 'val-entrada' : 'val-saida';
            
            // Formatação de parênteses
            if (!isPositive) {
                valFormat = `(${val.toLocaleString('pt-BR', { minimumFractionDigits: 2 })})`;
            } else {
                valFormat = `+ ${val.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            }

            return `<tr class="${classes}">
                <td>${desc}</td>
                <td class="col-valor ${corVal}">${valFormat}</td>
                <td class="col-av"></td>
            </tr>`;
        }



        // Função Auxiliar de Agregação
        function addDetalhe(groupObj, cat, sub, val) {
            if (!groupObj[cat]) groupObj[cat] = { total: 0, subs: {} };
            groupObj[cat].total += val;
            if (!groupObj[cat].subs[sub]) groupObj[cat].subs[sub] = 0;
            groupObj[cat].subs[sub] += val;
        }
    </script>
</body>
</html>