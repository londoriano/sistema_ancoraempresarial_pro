<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRE Gerencial | Âncora</title>
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* Layout */
        #wrapper { display: flex; width: 100%; }
        #sidebar-wrapper {
            min-height: 100vh; width: 250px; margin-left: -250px;
            background-color: #2c3e50; transition: margin 0.25s ease-out;
            position: fixed; z-index: 1000;
        }
        #sidebar-wrapper .sidebar-heading { padding: 1.5rem; font-size: 1.2rem; color: white; font-weight: bold; }
        #sidebar-wrapper .list-group-item { background-color: transparent; color: rgba(255,255,255,0.7); border: none; padding: 1rem 1.5rem; }
        #sidebar-wrapper .list-group-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        #sidebar-wrapper .list-group-item.active { background-color: #1a252f; color: white; font-weight: bold; border-left: 4px solid #0dcaf0; }
        #page-content-wrapper { width: 100%; margin-left: 0; transition: margin 0.25s ease-out; }
        @media (min-width: 768px) { #sidebar-wrapper { margin-left: 0; } #page-content-wrapper { margin-left: 250px; } }

        /* Estilos DRE Tabela */
        .card-dre { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .table-dre { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .table-dre th, .table-dre td { padding: 5px 10px; border-bottom: 1px solid #f1f3f5; vertical-align: middle; }
        .table-dre thead th { border-bottom: 2px solid #dee2e6; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- CORES DE VALORES (Forçamos a prioridade) --- */
        .val-entrada { color: #198754 !important; font-weight: 600; } 
        .val-saida { color: #dc3545 !important; font-weight: 600; }   
        
        /* --- LINHAS DE RESULTADO --- */
        .res-receita-bruta { background-color: #e8f1f8; color: #0d47a1; font-weight: 800; border-top: 2px solid #0d47a1; }
        .res-receita-liq { background-color: #e0f2f1; color: #00695c; font-weight: 800; border-top: 1px solid #80cbc4; }
        .res-lucro-bruto { background-color: #fff8e1; color: #e65100; font-weight: 800; border-top: 2px solid #ffb300; }
        .res-ebitda { background-color: #f3e5f5; color: #4a148c; font-weight: 800; border-top: 2px solid #8e24aa; font-size: 1.05rem; }
        .res-ebit { background-color: #e8eaf6; color: #283593; font-weight: 700; border-top: 1px solid #9fa8da; }
        .res-lair { background-color: #efebe9; color: #4e342e; font-weight: 700; }
        .res-final-lucro { background-color: #198754; color: white !important; font-weight: 900; font-size: 1.2rem; border-top: 4px double white; }
        .res-final-preju { background-color: #dc3545; color: white !important; font-weight: 900; font-size: 1.2rem; border-top: 4px double white; }
        
        /* Linhas Comuns */
        .dre-cat-row { 
            font-size: 0.75rem; 
            color: #495057; 
            font-weight: 600; 
            background-color: #fff; 
        }
        /* Aplica opacidade apenas na descrição, não no valor, para não apagar a cor */
        .dre-cat-row td:first-child { opacity: 0.6; } 

        /* Linha de Subcategoria */
        .dre-sub-row { 
            font-size: 0.8rem; 
            color: #6c757d; 
            background-color: #fff; 
        }

        /* Cabeçalho da Categoria (Apenas Título, sem valor) */
        .dre-cat-header { 
            font-size: 0.85rem; 
            color: #212529; 
            font-weight: 700; 
            background-color: #fff; 
            border-bottom: 1px dashed #f1f3f5;
            padding-top: 10px !important; /* Espaço extra para separar grupos */
        }

        /* Rodapé de Total da Categoria (Fonte menor e opacidade) */
        .dre-cat-total { 
            font-size: 0.75rem; 
            color: #495057; 
            font-weight: 700; 
            opacity: 0.6; /* O visual "apagado" que você pediu */
            background-color: #f8f9fa; 
            border-top: 1px solid #e9ecef;
            font-style: italic;
        }

        /* Ajuste de Colunas */
        .col-valor { text-align: right; font-family: 'Consolas', monospace; width: 300px; } /* Aumentei um pouco para caber o sinal */
        .col-av { text-align: right; width: 80px; font-size: 0.8em; color: #adb5bd; }
        .indent-0 { padding-left: 10px !important; }
        .indent-cat { padding-left: 25px !important; }
        .indent-sub { padding-left: 45px !important; }

        /* --- ESTILOS DE IMPRESSÃO (PDF LIMPO) --- */
        @media print {
            /* 1. Remove cabeçalhos e rodapés automáticos do navegador (Data/URL) */
            @page { 
                margin: 0; 
                size: auto; 
            }

            /* 2. Adiciona margem manual ao conteúdo para não colar na borda do papel */
            body { 
                margin: 1.5cm 1cm !important; 
                background-color: white !important;
                -webkit-print-color-adjust: exact !important; /* Força impressão de cores de fundo */
                print-color-adjust: exact !important;
            }

            /* 3. Esconde Sidebar, Navbar, Botões e Ícones */
            #sidebar-wrapper, 
            .navbar, 
            .btn, 
            .bi-trash, 
            .modal { 
                display: none !important; 
            }

            /* 4. Expande o conteúdo para usar a folha toda */
            #page-content-wrapper { 
                margin-left: 0 !important; 
                width: 100% !important; 
                padding: 0 !important;
            }
            
            .container-fluid { padding: 0 !important; }
            .card { border: none !important; box-shadow: none !important; }
            .card-header { background-color: white !important; border-bottom: 2px solid #000 !important; }
            
            /* Ajuste de fonte para caber melhor no papel A4 */
            .table-dre { font-size: 0.8rem !important; }
            .dre-cat-header { background-color: #eee !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="d-flex" id="wrapper">
        <div id="sidebar-wrapper">
            <div class="sidebar-heading"><i class="bi bi-building"></i> Âncora PRO</div>
            <div class="list-group list-group-flush mt-3">
                <a href="#" onclick="irPara('dados_empresa.html')" class="list-group-item list-group-item-action">
                    <i class="bi bi-clipboard-data me-2"></i> Diagnóstico
                </a>
                <a href="#" onclick="irPara('fluxo_caixa.html')" class="list-group-item list-group-item-action">
                    <i class="bi bi-cash-stack me-2"></i> Fluxo de Caixa
                </a>
                <a href="#" class="list-group-item list-group-item-action active">
                    <i class="bi bi-file-earmark-spreadsheet me-2"></i> DRE Gerencial
                </a>
                <div class="mt-5 border-top border-secondary pt-3 px-3">
                    <a href="clientes.html" class="btn btn-outline-light w-100 btn-sm">
                        <i class="bi bi-arrow-left"></i> Voltar para Carteira
                    </a>
                </div>
            </div>
        </div>

        <div id="page-content-wrapper">

            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-3 sticky-top shadow-sm">
                <button class="btn btn-primary d-md-none" id="sidebarToggle"><i class="bi bi-list"></i></button>
                <h5 class="ms-3 mb-0 fw-bold text-secondary" id="headerEmpresa">Carregando...</h5>
                <div class="ms-auto d-flex align-items-center gap-2">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light">De</span>
                        <input type="month" id="mesInicio" class="form-control">
                        <span class="input-group-text bg-light">Até</span>
                        <input type="month" id="mesFim" class="form-control">
                        <button class="btn btn-primary fw-bold" onclick="gerarDRE()">
                            <i class="bi bi-filter"></i> Filtrar
                        </button>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm ms-2" onclick="abrirModalImpostos()">
                        <i class="bi bi-gear-fill"></i> Config. IR/CSLL
                    </button>
                    <button class="btn btn-outline-dark btn-sm" onclick="window.print()">
                        <i class="bi bi-printer"></i>
                    </button>
                </div>
            </nav>

            <div class="container-fluid py-4 px-4">
                
                <div class="card card-dre">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-table"></i> Demonstrativo do Resultado</h5>
                        <p class="mb-0 small text-muted">Regime de Competência | Estrutura: Receita - Custos = Lucro Bruto - Despesas = Operacional</p>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table-dre">
                                <thead>
                                    <tr class="bg-light">
                                        <th class="ps-3">DESCRIÇÃO DA CONTA</th>
                                        <th class="col-valor">VALOR (R$)</th>
                                        <th class="col-av">AV %</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaDreBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalImpostos" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title">Configurar Tributação sobre Lucro</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Adicione os impostos que incidem sobre o <strong>Resultado Antes do IR (LAIR)</strong>. Ex: IRPJ (15%), CSLL (9%), Adicional IR (10%).</p>
                    
                    <div class="input-group mb-3">
                        <input type="text" id="novoImpNome" class="form-control" placeholder="Nome (ex: IRPJ)">
                        <input type="number" id="novoImpAliq" class="form-control" placeholder="%" step="0.01" style="max-width: 80px;">
                        <button class="btn btn-primary" onclick="addImposto()">Adicionar</button>
                    </div>

                    <ul class="list-group" id="listaImpostos">
                        </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        const DB_KEY = 'ancora_empresas';
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('id');

        document.addEventListener('DOMContentLoaded', () => {
            if(!clientId) { alert("Empresa não selecionada."); window.location.href='clientes.html'; return; }
            document.getElementById('sidebarToggle').addEventListener('click', e => { e.preventDefault(); document.body.classList.toggle('sb-sidenav-toggled'); });
            
            // Define Mês Atual como Padrão
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            document.getElementById('mesInicio').value = `${ano}-${mes}`;
            document.getElementById('mesFim').value = `${ano}-${mes}`;

            carregarDados();
        });

        function getDB() { return JSON.parse(localStorage.getItem(DB_KEY)) || []; }
        // --- ADICIONE ESTA FUNÇÃO QUE ESTÁ FALTANDO ---
        function saveDB(db) { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        // ----------------------------------------------
        function irPara(pg) { window.location.href = `${pg}?id=${clientId}`; }

        function carregarDados() {
            const db = getDB();
            const empresa = db.find(c => c.id === clientId);
            if(empresa) document.getElementById('headerEmpresa').innerText = empresa.empresa;
            gerarDRE();
        }

        // --- GERENCIAMENTO DE IMPOSTOS ---
        function abrirModalImpostos() {
            renderListaImpostos();
            new bootstrap.Modal(document.getElementById('modalImpostos')).show();
        }

        function addImposto() {
            const nome = document.getElementById('novoImpNome').value;
            const aliq = parseFloat(document.getElementById('novoImpAliq').value);
            if(!nome || isNaN(aliq)) return;

            const db = getDB();
            const idx = db.findIndex(c => c.id === clientId);
            
            // Inicializa array se não existir
            if(!db[idx].configImpostos) db[idx].configImpostos = [];
            
            db[idx].configImpostos.push({ id: Date.now(), nome, aliquota: aliq });
            saveDB(db);
            
            document.getElementById('novoImpNome').value = '';
            document.getElementById('novoImpAliq').value = '';
            renderListaImpostos();
            gerarDRE(); // Recalcula na hora
        }

        function renderListaImpostos() {
            const db = getDB();
            const empresa = db.find(c => c.id === clientId);
            const lista = document.getElementById('listaImpostos');
            lista.innerHTML = '';
            
            const impostos = empresa.configImpostos || [];
            
            if(impostos.length === 0) {
                lista.innerHTML = '<li class="list-group-item text-center text-muted small">Nenhum imposto configurado (Lucro Real/Presumido).</li>';
                return;
            }

            impostos.forEach((imp, i) => {
                lista.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${imp.nome} <strong class="ms-2">(${imp.aliquota}%)</strong></span>
                        <i class="bi bi-trash text-danger cursor-pointer" onclick="delImposto(${i})"></i>
                    </li>
                `;
            });
        }

        function delImposto(idx) {
            const db = getDB();
            const i = db.findIndex(c => c.id === clientId);
            db[i].configImpostos.splice(idx, 1);
            saveDB(db);
            renderListaImpostos();
            gerarDRE();
        }

        // --- MOTOR DE CÁLCULO DRE (NOVA ESTRUTURA) ---
        // --- MOTOR DE CÁLCULO DRE (COM CORES CORRIGIDAS) ---
        function gerarDRE() {
            const db = getDB();
            const empresa = db.find(c => c.id === clientId);
            if(!empresa || !empresa.financeiro) return;

            const inicio = document.getElementById('mesInicio').value;
            const fim = document.getElementById('mesFim').value;

           // FILTRO DE DATA (Alterado para COMPETÊNCIA)
            const lancs = empresa.financeiro.filter(l => {
                // Se existe dataCompetencia, usa ela. Se não, usa a data normal (fallback).
                const dataConsiderada = l.dataCompetencia || l.data;
                
                return dataConsiderada.slice(0, 7) >= inicio && 
                       dataConsiderada.slice(0, 7) <= fim;
            });

            // ESTRUTURA DE DADOS
            let DRE = {
                receitaBruta: 0, deducoes: 0, custosTotais: 0, despesasTotais: 0, 
                receitaFin: 0, despesaFin: 0, depreciacao: 0,
                detalhes: { 
                    rec: {}, ded: {}, custos: {}, desp: {}, rf: {}, dfn: {}, dep: {}
                }
            };

            // CLASSIFICAÇÃO
            lancs.forEach(l => {
                const val = l.valor;
                const cat = l.categoria; 
                const sub = l.subcategoria || '-';
                const catLower = cat.toLowerCase();
                
                if (l.tipo === 'Receita') {
                    if (catLower.includes('financeira') || catLower.includes('aplicação')) {
                        DRE.receitaFin += val;
                        addDetalhe(DRE.detalhes.rf, cat, sub, val);
                    } else {
                        DRE.receitaBruta += val;
                        addDetalhe(DRE.detalhes.rec, cat, sub, val);
                    }
                } 
                else { // SAÍDAS
                    if (catLower.includes('imposto') || catLower.includes('simples') || catLower.includes('taxas')) {
                        DRE.deducoes += val;
                        addDetalhe(DRE.detalhes.ded, cat, sub, val);
                    }
                    else if (catLower.includes('banco') || catLower.includes('juros') || catLower.includes('financeira')) {
                        DRE.despesaFin += val;
                        addDetalhe(DRE.detalhes.dfn, cat, sub, val);
                    }
                    else if (catLower.includes('depreciação') || catLower.includes('amortização')) {
                        DRE.depreciacao += val;
                        addDetalhe(DRE.detalhes.dep, cat, sub, val);
                    }
                    else {
                        // Separação Operacional (Custos vs Despesas)
                        const nat = l.natureza || 'Despesa';
                        if (nat === 'Custo') {
                            DRE.custosTotais += val;
                            addDetalhe(DRE.detalhes.custos, cat, sub, val);
                        } else {
                            DRE.despesasTotais += val;
                            addDetalhe(DRE.detalhes.desp, cat, sub, val);
                        }
                    }
                }
            });

            // --- CÁLCULOS ---
            const receitaLiquida = DRE.receitaBruta - DRE.deducoes;
            const lucroBruto = receitaLiquida - DRE.custosTotais;
            const ebitda = lucroBruto - DRE.despesasTotais;
            const ebit = ebitda - DRE.depreciacao;
            const resFinanceiro = DRE.receitaFin - DRE.despesaFin;
            const lair = ebit + resFinanceiro;

            // Impostos
            const impostosConfig = empresa.configImpostos || [];
            let totalImpostosLucro = 0;
            let detalheImpostosHtml = '';
            if (lair > 0 && impostosConfig.length > 0) {
                impostosConfig.forEach(imp => {
                    const valorImp = lair * (imp.aliquota / 100);
                    totalImpostosLucro += valorImp;
                    detalheImpostosHtml += renderLinhaSimples(imp.nome + ` (${imp.aliquota}%)`, valorImp, 'dre-sub-row indent-sub', false);
                });
            }
            const lucroLiquido = lair - totalImpostosLucro;


            // --- RENDERIZAÇÃO ---
            const tbody = document.getElementById('tabelaDreBody');
            tbody.innerHTML = '';

           // Função R (Renderizadora de Linha com Sinais + / -)
            const R = (desc, val, estilo = '', nivel = 0, forceRed = false) => {
                // Tratamento para Títulos de Categoria (Sem Valor)
                if (val === null) {
                    let indent = nivel === 1 ? 'indent-cat' : 'indent-0';
                    return `<tr class="${estilo}"><td class="${indent}" colspan="3">${desc}</td></tr>`;
                }

                const av = (DRE.receitaBruta > 0) ? (val / DRE.receitaBruta * 100).toFixed(1) + '%' : '-';
                let indentClass = nivel === 1 ? 'indent-cat' : (nivel === 2 ? 'indent-sub' : 'indent-0');
                
                // Lógica de Cores e Sinais
                let corVal = 'text-dark';
                let sinal = '';

                // Se for linha FINAL (Sólida), força BRANCO
                if (estilo.includes('res-final')) {
                    corVal = 'text-white';
                    // Na linha final, o sinal segue a matemática simples (Lucro + / Prejuízo -)
                    sinal = val >= 0 ? '+ ' : ''; 
                    // Nota: Não forçamos "-" aqui pois o numberFormat já traria o negativo se fosse o caso, 
                    // mas para consistência visual vamos deixar o browser formatar o negativo e só por o + no positivo.
                } 
                else {
                    // É Saída/Despesa? (Vermelho e Sinal Menos)
                    if (desc.includes('(-)') || desc.includes('Imposto') || desc.includes('Custo') || desc.includes('Despesa') || forceRed) {
                        corVal = 'val-saida';
                        sinal = '- ';
                    }
                    // É Receita/Positivo? (Verde e Sinal Mais)
                    else if (val >= 0) {
                        corVal = 'val-entrada';
                        sinal = '+ ';
                    }
                }

                // Formatação Numérica
                // Usamos Math.abs(val) porque o sinal (+ ou -) já será colocado manualmente na string
                let valNumerico = Math.abs(val).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                let valFinal = `${sinal}R$ ${valNumerico}`;

                // Ajuste específico para Prejuízo na linha final (para não ficar "- -R$...")
                if (estilo.includes('res-final') && val < 0) {
                    valFinal = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                }

                return `<tr class="${estilo}"><td class="${indentClass}">${desc}</td><td class="col-valor ${corVal}">${valFinal}</td><td class="col-av">${desc.includes('AV') ? '' : av}</td></tr>`;
            };

           // Função RenderGroup (NOVA LÓGICA: Título -> Subs -> Total)
            const RenderGroup = (objDetalhes, isExpense = false) => {
                let html = '';
                for(let [cat, info] of Object.entries(objDetalhes)) {
                    
                    // 1. Título da Categoria (Valor NULL para não exibir nada na coluna de valor)
                    html += R(cat, null, 'dre-cat-header', 1, isExpense);
                    
                    // 2. Subcategorias (Valores Individuais)
                    for(let [sub, sVal] of Object.entries(info.subs)) {
                        html += R(sub, sVal, 'dre-sub-row', 2, isExpense);
                    }

                    // 3. Total da Categoria (Rodapé com Opacidade)
                    html += R(`Total ${cat}`, info.total, 'dre-cat-total', 1, isExpense);
                }
                return html;
            };

            let html = '';
            
            // 1. Receita Bruta
            html += R('(=) RECEITA BRUTA OPERACIONAL', DRE.receitaBruta, 'res-receita-bruta');
            html += RenderGroup(DRE.detalhes.rec, false); // false = não é despesa
            
            // 2. Deduções
            html += R('(-) Deduções e Impostos s/ Venda', DRE.deducoes, 'text-muted fw-bold');
            html += RenderGroup(DRE.detalhes.ded, true); // true = é despesa (pintar subs de vermelho)
            
            // 3. Receita Líquida
            html += R('(=) RECEITA LÍQUIDA', receitaLiquida, 'res-receita-liq');
            
            // 4. Custos
            html += R('(-) Custos Operacionais', DRE.custosTotais, 'text-muted fw-bold');
            html += RenderGroup(DRE.detalhes.custos, true); // true

            // 5. Lucro Bruto
            html += R('(=) LUCRO BRUTO', lucroBruto, 'res-lucro-bruto');
            
            // 6. Despesas
            html += R('(-) Despesas Operacionais', DRE.despesasTotais, 'text-muted fw-bold');
            html += RenderGroup(DRE.detalhes.desp, true); // true
            
            html += '<tr><td colspan="3" class="bg-light p-1"></td></tr>';

            // 7. EBITDA
            html += R('(=) EBITDA (Lajida)', ebitda, 'res-ebitda');
            
            if(DRE.depreciacao > 0) {
                html += R('(-) Depreciação / Amortização', DRE.depreciacao, 'text-muted fw-bold');
                html += RenderGroup(DRE.detalhes.dep, true); // true
            }
            
            // 8. EBIT
            html += R('(=) EBIT (Resultado Operacional)', ebit, 'res-ebit');

            // 9. Financeiro
            if(DRE.receitaFin > 0 || DRE.despesaFin > 0) {
                html += '<tr><td colspan="3" class="fw-bold text-muted mt-2 border-0 small ps-3">Resultado Financeiro</td></tr>';
                if(DRE.receitaFin > 0) { html += R('(+) Receitas Financeiras', DRE.receitaFin, 'text-success'); html += RenderGroup(DRE.detalhes.rf, false); }
                if(DRE.despesaFin > 0) { html += R('(-) Despesas Financeiras', DRE.despesaFin, 'text-danger'); html += RenderGroup(DRE.detalhes.dfn, true); }
            }
            
            // 10. LAIR
            html += R('(=) LAIR (Lucro Antes do IR)', lair, 'res-lair');

            // 11. Impostos
            if (totalImpostosLucro > 0) {
                html += R('(-) IR e Contribuição Social', totalImpostosLucro, 'text-muted fw-bold');
                html += detalheImpostosHtml; 
            }

            // 12. Final
            const classeFinal = lucroLiquido >= 0 ? 'res-final-lucro' : 'res-final-preju';
            const labelFinal = lucroLiquido >= 0 ? '(=) LUCRO LÍQUIDO DO PERÍODO' : '(=) PREJUÍZO LÍQUIDO DO PERÍODO';
            html += R(labelFinal, lucroLiquido, classeFinal);

            tbody.innerHTML = html;
        }

        // Função Helper para renderizar linhas manuais (impostos)
        function renderLinhaSimples(desc, val, classes, isPositive) {
            const valFormat = `(${val.toLocaleString('pt-BR', { minimumFractionDigits: 2 })})`;
            return `<tr class="${classes}">
                <td>${desc}</td>
                <td class="col-valor val-saida">${valFormat}</td>
                <td class="col-av"></td>
            </tr>`;
        }

        // Função Auxiliar de Agregação
        function addDetalhe(groupObj, cat, sub, val) {
            if (!groupObj[cat]) groupObj[cat] = { total: 0, subs: {} };
            groupObj[cat].total += val;
            if (!groupObj[cat].subs[sub]) groupObj[cat].subs[sub] = 0;
            groupObj[cat].subs[sub] += val;
        }
    </script>
</body>
</html>