<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Empresas | Âncora</title>
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .navbar-brand { font-weight: bold; color: #2c3e50 !important; }
        .btn-brand { background-color: #2c3e50; color: white; border-color: #2c3e50; }
        .btn-brand:hover { background-color: #1a252f; color: white; }
        .table-hover tbody tr:hover { background-color: rgba(44, 62, 80, 0.05); }
        
        /* Badges e Cores */
        .badge-lead { background-color: #6c757d; color: white; }
        .badge-cliente { background-color: #198754; color: white; }
        .border-lead { border-left: 5px solid #6c757d !important; }
        .border-cliente { border-left: 5px solid #198754 !important; }
        
        /* Animação do Alerta */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand" ><i class="bi bi-building"></i> Âncora Empresarial</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto gap-2">
                    <li class="nav-item">
                        <button class="btn btn-outline-secondary btn-sm mt-1" data-bs-toggle="modal" data-bs-target="#modalBackup">
                            <i class="bi bi-database-gear"></i> Backup
                        </button>
                    </li>
                    <li class="nav-item"><a class="nav-link text-danger" href="#" onclick="logout()">Sair</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <div id="alertaBackup" class="alert alert-danger border-danger shadow-sm d-none fade-in mb-4" role="alert">
            <div class="d-flex align-items-center">
                <div class="fs-1 me-3 text-danger"><i class="bi bi-cloud-slash-fill"></i></div>
                <div>
                    <h5 class="alert-heading fw-bold m-0">Risco de Perda de Dados!</h5>
                    <p class="mb-0 small">O último backup foi realizado há mais de <strong>7 dias</strong>.</p>
                </div>
                <button class="btn btn-danger fw-bold ms-auto px-4" onclick="exportarJSON()">
                    <i class="bi bi-download"></i> FAZER BACKUP
                </button>
            </div>
        </div>

        <div class="row align-items-center mb-4">
            <div class="col-md-8">
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <h3 class="m-0 fw-bold text-dark">Carteira</h3>
                    <div class="d-flex gap-2">
                        <span class="badge badge-lead fs-6 shadow-sm" id="countLeads">Leads: 0</span>
                        <span class="badge badge-cliente fs-6 shadow-sm" id="countClientes">Clientes: 0</span>
                        <span class="badge bg-white text-dark border fs-6 shadow-sm" id="countTotal">Total: 0</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-brand shadow-sm" data-bs-toggle="modal" data-bs-target="#modalCliente" onclick="limparFormulario()">
                    <i class="bi bi-plus-lg"></i> Nova Empresa
                </button>
            </div>
        </div>

        <div class="card mb-3 p-3 bg-white border-0 shadow-sm">
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" id="inputBusca" class="form-control border-start-0 ps-0" placeholder="Buscar Empresa, Sócio ou Email..." onkeyup="aplicarFiltros()">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="filtroStatus" class="form-select" onchange="aplicarFiltros()">
                        <option value="todos">Status: Todos</option>
                        <option value="Lead">Apenas Leads</option>
                        <option value="Cliente">Apenas Clientes</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="filtroOrdem" class="form-select" onchange="aplicarFiltros()">
                        <option value="criacao">Mais Recentes</option>
                        <option value="alfabetica">A-Z (Empresa)</option>
                        <option value="diagnostico">Próximos Diagnósticos</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 5px;"></th> <th class="ps-3">Empresa / Status</th>
                                <th>Diagnóstico</th>
                                <th>Sócio Principal</th>
                                <th>Contato</th>
                                <th class="text-end pe-4">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaClientes"></tbody>
                    </table>
                </div>
                <div id="msgVazio" class="text-center py-5 text-muted d-none">
                    <i class="bi bi-filter-circle display-6 mb-3 d-block opacity-50"></i>
                    Nenhum registro encontrado para os filtros atuais.
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCliente" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Dados da Empresa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCliente" onsubmit="salvarCliente(event)">
                        <input type="hidden" id="clienteId">
                        <input type="hidden" id="dataCriacao">
                        
                        <div class="row g-3 mb-3 bg-light p-3 rounded border mx-1">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="status" required onchange="toggleValor()">
                                    <option value="Lead">Lead (Prospect)</option>
                                    <option value="Cliente">Cliente (Ativo)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Data Diagnóstico</label>
                                <input type="date" class="form-control" id="dataDiagnostico">
                            </div>
                            <div class="col-md-4 d-none" id="divValor">
                                <label class="form-label fw-bold text-success">Valor Mensal (R$)</label>
                                <input type="number" step="0.01" class="form-control" id="valorConsultoria">
                            </div>
                        </div>

                        <h6 class="text-muted border-bottom pb-2 mb-3 mt-3">Corporativo</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nome da Empresa <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="empresa" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">CNPJ</label>
                                <input type="text" class="form-control" id="cnpj" placeholder="00.000.000/0000-00">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email Corporativo <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" required placeholder="contato@empresa.com">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Telefone Fixo</label>
                                <input type="text" class="form-control" id="telefone">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ramo de Atividade</label>
                                <input type="text" class="form-control" id="ramo">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Endereço</label>
                                <input type="text" class="form-control" id="endereco">
                            </div>
                        </div>

                        <h6 class="text-muted border-bottom pb-2 mb-3 mt-4">Sócios</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Sócio 1 (Principal) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="socio1" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Celular Sócio 1 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="contato1" 
                                       placeholder="48 9 9999-9999" maxlength="16" oninput="mascaraCelular(this)" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sócio 2</label>
                                <input type="text" class="form-control" id="socio2">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Celular Sócio 2</label>
                                <input type="text" class="form-control" id="contato2" 
                                       placeholder="48 9 9999-9999" maxlength="16" oninput="mascaraCelular(this)">
                            </div>
                        </div>

                        <div class="modal-footer px-0 pb-0 mt-4">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-brand fw-bold">Salvar Dados</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalBackup" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title">Gestão de Dados</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <button type="button" class="btn btn-success w-100 fw-bold mb-3" onclick="exportarJSON()">
                        <i class="bi bi-download"></i> BAIXAR BACKUP (JSON)
                    </button>
                    <input type="file" id="arquivoJson" class="form-control mb-2" accept=".json">
                    <button type="button" class="btn btn-outline-danger w-100" onclick="restaurarBackup()">
                        <i class="bi bi-upload"></i> Restaurar Backup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        const DB_KEY = 'ancora_empresas';
        const BACKUP_TIME_KEY = 'ancora_empresarial_last_backup';

        document.addEventListener('DOMContentLoaded', () => {
            aplicarFiltros(); // Carrega a lista inicial
            verificarStatusBackup();
            toggleValor(); // Ajusta o modal inicial
        });

        // --- LÓGICA DE UI ---
        function toggleValor() {
            const status = document.getElementById('status').value;
            const divValor = document.getElementById('divValor');
            if(status === 'Cliente') {
                divValor.classList.remove('d-none');
            } else {
                divValor.classList.add('d-none');
            }
        }

        function mascaraCelular(input) {
            let v = input.value.replace(/\D/g, "");
            if (v.length > 2) v = v.replace(/^(\d{2})(\d)/, "$1 $2");
            if (v.length > 3) v = v.replace(/^(\d{2}) (\d)(\d)/, "$1 $2 $3");
            if (v.length > 7) v = v.replace(/^(\d{2}) (\d) (\d{4})(\d)/, "$1 $2 $3-$4");
            input.value = v;
        }

        function formatarMoeda(valor) {
            if(!valor) return '';
            return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function formatarData(data) {
            if(!data) return '-';
            return data.split('-').reverse().join('/');
        }

        // --- CRUD E FILTROS ---

        function salvarCliente(e) {
            e.preventDefault();
            const id = document.getElementById('clienteId').value || Date.now().toString();
            const status = document.getElementById('status').value;

            const novoCliente = {
                id: id,
                status: status, // Lead ou Cliente
                dataDiagnostico: document.getElementById('dataDiagnostico').value,
                valorConsultoria: status === 'Cliente' ? document.getElementById('valorConsultoria').value : 0,
                dataCriacao: document.getElementById('dataCriacao').value || new Date().toISOString(),
                
                empresa: document.getElementById('empresa').value,
                cnpj: document.getElementById('cnpj').value,
                email: document.getElementById('email').value,
                ramo: document.getElementById('ramo').value,
                telefone: document.getElementById('telefone').value,
                endereco: document.getElementById('endereco').value,
                socio1: document.getElementById('socio1').value,
                contato1: document.getElementById('contato1').value,
                socio2: document.getElementById('socio2').value,
                contato2: document.getElementById('contato2').value
            };

            let clientes = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            const index = clientes.findIndex(c => c.id === id);
            
            if(index > -1) clientes[index] = novoCliente;
            else clientes.push(novoCliente);

            localStorage.setItem(DB_KEY, JSON.stringify(clientes));
            bootstrap.Modal.getInstance(document.getElementById('modalCliente')).hide();
            aplicarFiltros(); // Atualiza a lista e contadores
        }

        function aplicarFiltros() {
            let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            
            // 1. Atualizar Contadores
            const countLeads = db.filter(c => c.status === 'Lead').length;
            const countClientes = db.filter(c => c.status === 'Cliente').length;
            document.getElementById('countLeads').innerText = `Leads: ${countLeads}`;
            document.getElementById('countClientes').innerText = `Clientes: ${countClientes}`;
            document.getElementById('countTotal').innerText = `Total: ${db.length}`;

            // 2. Filtros
            const termo = document.getElementById('inputBusca').value.toLowerCase();
            const filtroStatus = document.getElementById('filtroStatus').value;
            const ordem = document.getElementById('filtroOrdem').value;

            // Filtro Texto
            if(termo) {
                db = db.filter(c => 
                    c.empresa.toLowerCase().includes(termo) || 
                    c.socio1.toLowerCase().includes(termo) ||
                    (c.email && c.email.toLowerCase().includes(termo))
                );
            }

            // Filtro Status
            if(filtroStatus !== 'todos') {
                db = db.filter(c => c.status === filtroStatus);
            }

            // 3. Ordenação
            if(ordem === 'alfabetica') {
                db.sort((a, b) => a.empresa.localeCompare(b.empresa));
            } else if (ordem === 'diagnostico') {
                // Filtra quem tem data futura ou presente
                const hoje = new Date().toISOString().split('T')[0];
                db.sort((a, b) => {
                    // Se não tem data, joga pro fim
                    if(!a.dataDiagnostico) return 1;
                    if(!b.dataDiagnostico) return -1;
                    return new Date(a.dataDiagnostico) - new Date(b.dataDiagnostico);
                });
            } else { // 'criacao' (Recentes)
                db.sort((a, b) => new Date(b.dataCriacao || 0) - new Date(a.dataCriacao || 0));
            }

            renderizarTabela(db);
        }

        function renderizarTabela(lista) {
            const tbody = document.getElementById('tabelaClientes');
            const msgVazio = document.getElementById('msgVazio');
            tbody.innerHTML = '';

            if(lista.length === 0) {
                msgVazio.classList.remove('d-none');
                return;
            }
            msgVazio.classList.add('d-none');

            lista.forEach(c => {
                const isCliente = c.status === 'Cliente';
                const badgeClass = isCliente ? 'badge-cliente' : 'badge-lead';
                const borderClass = isCliente ? 'border-cliente' : 'border-lead';
                
                // Exibe valor se for cliente
                const valorHtml = (isCliente && c.valorConsultoria > 0) 
                    ? `<div class="text-success small fw-bold mt-1"><i class="bi bi-cash"></i> ${formatarMoeda(c.valorConsultoria)}</div>` 
                    : '';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="${borderClass}" style="padding:0;"></td>
                    <td class="ps-3">
                        <div class="fw-bold text-dark">${c.empresa}</div>
                        <span class="badge ${badgeClass}">${c.status || 'Lead'}</span>
                        ${valorHtml}
                        <div class="small text-muted mt-1">${c.ramo || ''}</div>
                    </td>
                    <td>
                        <div class="small text-muted">Data:</div>
                        <strong class="text-dark">${formatarData(c.dataDiagnostico)}</strong>
                    </td>
                    <td>${c.socio1}</td>
                    <td>
                        <div class="font-monospace">${c.contato1}</div>
                        <div class="small text-muted text-truncate" style="max-width: 150px;" title="${c.email}">${c.email || '-'}</div>
                    </td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editar('${c.id}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluir('${c.id}')"><i class="bi bi-trash"></i></button>
                        <a href="dados_empresa.html?id=${c.id}" class="btn btn-sm btn-dark fw-bold"><i class="bi bi-arrow-right"></i></a>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editar(id) {
            const clientes = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            const c = clientes.find(c => c.id === id);
            if(!c) return;

            document.getElementById('clienteId').value = c.id;
            document.getElementById('dataCriacao').value = c.dataCriacao;
            
            // Novos Campos
            document.getElementById('status').value = c.status || 'Lead';
            document.getElementById('dataDiagnostico').value = c.dataDiagnostico || '';
            document.getElementById('valorConsultoria').value = c.valorConsultoria || '';
            document.getElementById('email').value = c.email || '';

            // Campos Antigos
            document.getElementById('empresa').value = c.empresa;
            document.getElementById('cnpj').value = c.cnpj;
            document.getElementById('ramo').value = c.ramo;
            document.getElementById('telefone').value = c.telefone;
            document.getElementById('endereco').value = c.endereco;
            document.getElementById('socio1').value = c.socio1;
            document.getElementById('contato1').value = c.contato1;
            document.getElementById('socio2').value = c.socio2;
            document.getElementById('contato2').value = c.contato2;

            toggleValor(); // Atualiza visibilidade do campo valor
            new bootstrap.Modal(document.getElementById('modalCliente')).show();
        }

        function excluir(id) {
            if(confirm('Tem certeza?')) {
                let clientes = JSON.parse(localStorage.getItem(DB_KEY)) || [];
                clientes = clientes.filter(c => c.id !== id);
                localStorage.setItem(DB_KEY, JSON.stringify(clientes));
                aplicarFiltros();
            }
        }

        function limparFormulario() {
            document.getElementById('formCliente').reset();
            document.getElementById('clienteId').value = '';
            document.getElementById('status').value = 'Lead';
            toggleValor();
        }

        // --- SISTEMA DE BACKUP (Mantido) ---
        function verificarStatusBackup() {
            const ultimo = localStorage.getItem(BACKUP_TIME_KEY);
            const alerta = document.getElementById("alertaBackup");
            if (!ultimo || (new Date() - new Date(ultimo)) / (1000 * 60 * 60 * 24) > 7) {
                alerta.classList.remove("d-none");
            } else {
                alerta.classList.add("d-none");
            }
        }

        function exportarJSON() {
            const dados = localStorage.getItem(DB_KEY);
            if (!dados || dados === "[]") return alert("Banco vazio.");
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([dados], { type: 'application/json' }));
            link.download = `backup_ancora_empresarial_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            localStorage.setItem(BACKUP_TIME_KEY, new Date().toISOString());
            verificarStatusBackup();
        }

        function restaurarBackup() {
            const file = document.getElementById('arquivoJson').files[0];
            if(!file) return alert("Selecione um arquivo!");
            const reader = new FileReader();
            reader.onload = e => {
                if(confirm("Substituir dados atuais?")) {
                    localStorage.setItem(DB_KEY, e.target.result);
                    localStorage.setItem(BACKUP_TIME_KEY, new Date().toISOString());
                    location.reload();
                }
            };
            reader.readAsText(file);
        }

        function logout() { window.location.href = 'index.html'; }
    </script>
</body>
</html>